<!doctype html>
<html lang="zh-cn">

<head>
    <meta charset="utf-8" />
    <title>仪表盘</title>
    <meta name="renderer" content="webkit" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <link rel="stylesheet" href="/static/component/layui/css/layui.css" />
    <link rel="stylesheet" href="/static/nursery/nursery.css" />
    <script src="/static/component/layui/layui.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
</head>

<body>
    <div class="n-page">
        <header class="n-header">
            <h1 class="n-title">综合仪表盘</h1>
            <p class="n-subtitle">实时查看库存数据、库存构成与最新业务动态。</p>
        </header>

        <!-- Stats Cards -->
        <div class="n-stats" style="max-width: 900px; margin: 0 auto 32px;">
            <div class="n-stat-card">
                <div class="n-stat-label"><i class="layui-icon layui-icon-template-1"
                        style="color: var(--n-primary);"></i> 库存总量</div>
                <div class="n-stat-value n-stat-value--primary" id="stat-total">-</div>
            </div>
            <div class="n-stat-card">
                <div class="n-stat-label"><i class="layui-icon layui-icon-upload" style="color: #2563eb;"></i> 本月入库
                </div>
                <div class="n-stat-value n-stat-value--info" id="stat-in">-</div>
            </div>
            <div class="n-stat-card">
                <div class="n-stat-label"><i class="layui-icon layui-icon-slider" style="color: #f97316;"></i> 本月出库
                </div>
                <div class="n-stat-value" id="stat-out" style="color: #f97316;">-</div>
            </div>
            <div class="n-stat-card">
                <div class="n-stat-label"><i class="layui-icon layui-icon-notice" style="color: #dc2626;"></i> 低库存预警
                </div>
                <div class="n-stat-value n-stat-value--danger" id="stat-low">-</div>
            </div>
        </div>

        <!-- Charts -->
        <div style="max-width: 900px; margin: 0 auto 32px; display: flex; gap: 24px; flex-wrap: wrap;">
            <div class="n-card" style="flex: 1; min-width: 280px;">
                <div class="n-card__header">
                    <h3 class="n-card__title"><i class="layui-icon layui-icon-chart"></i> 库存构成占比</h3>
                </div>
                <div class="n-card__body">
                    <div id="chart-pie" style="height: 280px;"></div>
                </div>
            </div>
            <div class="n-card" style="flex: 1; min-width: 280px;">
                <div class="n-card__header">
                    <h3 class="n-card__title"><i class="layui-icon layui-icon-chart-screen"></i> 库存 TOP 5</h3>
                </div>
                <div class="n-card__body">
                    <div id="chart-bar" style="height: 280px;"></div>
                </div>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="n-card" style="max-width: 900px; margin: 0 auto;">
            <div class="n-card__header">
                <h3 class="n-card__title"><i class="layui-icon layui-icon-log"></i> 最新业务动态</h3>
            </div>
            <div id="activity-list" style="max-height: 300px; overflow-y: auto;">
                <div class="n-empty">
                    <div class="n-empty__text">加载中...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        layui.use(['jquery'], function () {
            var $ = layui.$;

            // Load stats
            $.ajax({
                url: '/api/v1/nursery/dashboard/stats',
                success: function (res) {
                    if (res.code === 0) {
                        var d = res.data;
                        $('#stat-total').text((d.total_quantity || 0).toLocaleString());
                        $('#stat-in').text('+' + (d.month_in || 0).toLocaleString());
                        $('#stat-out').text('-' + (d.month_out || 0).toLocaleString());
                        $('#stat-low').text(d.low_stock || 0);

                        // Pie Chart
                        if (d.category_data && d.category_data.length > 0) {
                            var pieChart = echarts.init(document.getElementById('chart-pie'));
                            pieChart.setOption({
                                tooltip: { trigger: 'item' },
                                color: ['#16a34a', '#22c55e', '#4ade80', '#86efac', '#bbf7d0'],
                                series: [{
                                    type: 'pie',
                                    radius: ['45%', '70%'],
                                    itemStyle: { borderRadius: 8, borderColor: '#fff', borderWidth: 2 },
                                    label: { show: true, formatter: '{b}: {c}' },
                                    data: d.category_data.map(function (c) { return { name: c.name, value: c.quantity }; })
                                }]
                            });
                        }

                        // Bar Chart
                        if (d.top_plants && d.top_plants.length > 0) {
                            var barChart = echarts.init(document.getElementById('chart-bar'));
                            barChart.setOption({
                                tooltip: { trigger: 'axis' },
                                grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
                                xAxis: { type: 'category', data: d.top_plants.map(function (p) { return p.name; }), axisLabel: { fontSize: 11 } },
                                yAxis: { type: 'value' },
                                series: [{
                                    type: 'bar',
                                    data: d.top_plants.map(function (p) { return p.quantity; }),
                                    itemStyle: { color: '#16a34a', borderRadius: [8, 8, 0, 0] }
                                }]
                            });
                        }
                    }
                }
            });

            // Load recent activity
            $.ajax({
                url: '/api/v1/nursery/transactions?limit=10',
                success: function (res) {
                    if (res.code === 0 && res.data.length > 0) {
                        var html = '';
                        res.data.forEach(function (t) {
                            var typeTag = t.type === 'in' ? '<span class="n-tag n-tag--success">入库</span>' : '<span class="n-tag n-tag--warning">出库</span>';
                            html += '<div style="padding: 14px 24px; border-bottom: 1px solid var(--n-slate-100); display: flex; align-items: center; gap: 12px;">';
                            html += typeTag;
                            html += '<span style="flex: 1; font-weight: 500;">' + (t.plant_name || '-') + ' (' + (t.spec || '统货') + ')</span>';
                            html += '<span style="color: var(--n-slate-600);">' + (t.type === 'in' ? '+' : '-') + t.quantity + '</span>';
                            html += '<span style="color: var(--n-slate-400); font-size: 12px;">' + (t.create_at || '-') + '</span>';
                            html += '</div>';
                        });
                        $('#activity-list').html(html);
                    } else {
                        $('#activity-list').html('<div class="n-empty"><div class="n-empty__text">暂无动态</div></div>');
                    }
                }
            });
        });
    </script>
</body>

</html>