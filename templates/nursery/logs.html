<!doctype html>
<html lang="zh-cn">

<head>
    <meta charset="utf-8" />
    <title>操作日志</title>
    <meta name="renderer" content="webkit" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <link rel="stylesheet" href="/static/component/layui/css/layui.css" />
    <link rel="stylesheet" href="/static/nursery/nursery.css" />
    <script src="/static/component/layui/layui.js"></script>
    <style>
        .n-log-grid {
            grid-template-columns: 1.5fr 0.7fr 2fr 1fr 1.5fr 1fr;
        }

        .action-btn {
            padding: 6px 8px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            background: transparent;
            font-size: 13px;
        }

        .action-btn:hover {
            background: var(--n-slate-100);
        }

        .action-btn--edit:hover {
            color: #2563eb;
            background: #dbeafe;
        }

        .action-btn--delete:hover {
            color: #dc2626;
            background: #fee2e2;
        }

        .edit-modal {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }

        .edit-modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .edit-modal__content {
            background: #fff;
            border-radius: 16px;
            width: 100%;
            max-width: 500px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        .edit-modal__header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--n-slate-100);
        }

        .edit-modal__body {
            padding: 24px;
        }

        .edit-modal__footer {
            padding: 16px 24px;
            border-top: 1px solid var(--n-slate-100);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }
    </style>
</head>

<body>
    <div class="n-page">
        <header class="n-header">
            <h1 class="n-title">操作日志</h1>
            <p class="n-subtitle">库存变动的所有审计记录。</p>
        </header>

        <div class="n-table-wrapper" style="max-width: 1000px; margin: 0 auto;">
            <div class="n-table-header n-log-grid">
                <span>单号 / 日期</span>
                <span>类型</span>
                <span>项目详情</span>
                <span>变动 & 单价</span>
                <span>备注信息</span>
                <span>操作</span>
            </div>
            <div id="logs-list">
                <div class="n-empty">
                    <div class="n-empty__text">加载中...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div class="edit-modal" id="edit-modal">
        <div class="edit-modal__content">
            <div class="edit-modal__header">
                <h3 class="n-card__title" style="font-size: 16px;">编辑操作日志</h3>
            </div>
            <div class="edit-modal__body">
                <div class="n-form-group">
                    <label class="n-label">苗木名称</label>
                    <input type="text" class="n-input" id="edit-plant-name">
                </div>
                <div class="n-form-row">
                    <div class="n-form-group">
                        <label class="n-label">规格</label>
                        <input type="text" class="n-input" id="edit-spec">
                    </div>
                    <div class="n-form-group">
                        <label class="n-label">单位</label>
                        <input type="text" class="n-input" id="edit-unit">
                    </div>
                </div>
                <div class="n-form-row">
                    <div class="n-form-group">
                        <label class="n-label">数量</label>
                        <input type="number" class="n-input" id="edit-quantity" step="0.01">
                    </div>
                    <div class="n-form-group">
                        <label class="n-label">单价(元)</label>
                        <input type="number" class="n-input" id="edit-price" step="0.01">
                    </div>
                </div>
                <div class="n-form-group">
                    <label class="n-label">操作员</label>
                    <input type="text" class="n-input" id="edit-operator">
                </div>
                <div class="n-form-group">
                    <label class="n-label">去向/来源</label>
                    <input type="text" class="n-input" id="edit-destination">
                </div>
                <div class="n-form-group">
                    <label class="n-label">仓库位置</label>
                    <input type="text" class="n-input" id="edit-location">
                </div>
                <div class="n-form-group">
                    <label class="n-label">备注</label>
                    <input type="text" class="n-input" id="edit-remark">
                </div>
            </div>
            <div class="edit-modal__footer">
                <button class="n-btn n-btn--secondary" onclick="closeEditModal()">取消</button>
                <button class="n-btn n-btn--primary" onclick="saveEdit()">保存</button>
            </div>
        </div>
    </div>

    <script>
        layui.use(['jquery', 'layer'], function () {
            var $ = layui.$;
            var layer = layui.layer;
            var editingLog = null;

            function loadLogs() {
                $.ajax({
                    url: '/api/v1/nursery/transactions?limit=100',
                    success: function (res) {
                        if (res.code === 0 && res.data.length > 0) {
                            var html = '';
                            res.data.forEach(function (log) {
                                var typeTag = log.type === 'in'
                                    ? '<span class="n-tag n-tag--success">入库</span>'
                                    : '<span class="n-tag n-tag--warning">出库</span>';
                                var changePrefix = log.type === 'in' ? '+' : '-';

                                html += '<div class="n-table-row n-log-grid">';
                                html += '<div><div class="n-font-bold" style="color: var(--n-info);">' + (log.order_no || '-') + '</div><div class="n-text-muted" style="font-size: 11px;">' + (log.create_at || '-') + '</div></div>';
                                html += '<div>' + typeTag + '</div>';
                                html += '<div>' + (log.plant_name || '-') + ' <span class="n-text-muted">(' + (log.spec || '-') + ')</span></div>';
                                html += '<div><span class="n-font-bold">' + changePrefix + log.quantity + '</span> <span class="n-text-muted">| ¥' + parseFloat(log.price || 0).toFixed(2) + '</span></div>';
                                html += '<div class="n-text-muted">' + (log.destination || '-') + (log.remark ? ' / ' + log.remark : '') + '</div>';
                                html += '<div style="display: flex; gap: 4px;">';
                                html += '<button class="action-btn action-btn--edit" title="编辑" onclick="openEditModal(' + log.id + ')"><i class="layui-icon layui-icon-edit"></i></button>';
                                html += '<button class="action-btn action-btn--delete" title="删除" onclick="deleteLog(' + log.id + ')"><i class="layui-icon layui-icon-delete"></i></button>';
                                html += '</div>';
                                html += '</div>';
                            });
                            $('#logs-list').html(html);
                        } else {
                            $('#logs-list').html('<div class="n-empty"><div class="n-empty__text">暂无记录</div></div>');
                        }
                    }
                });
            }

            // 编辑功能
            window.openEditModal = function (logId) {
                $.ajax({
                    url: '/api/v1/nursery/transactions?limit=100',
                    success: function (res) {
                        if (res.code === 0) {
                            editingLog = res.data.find(function (log) { return log.id === logId; });
                            if (editingLog) {
                                // 填充所有字段
                                $('#edit-plant-name').val(editingLog.plant_name || '');
                                $('#edit-spec').val(editingLog.spec || '');
                                $('#edit-unit').val(editingLog.unit || '');
                                $('#edit-quantity').val(editingLog.quantity || 0);
                                $('#edit-price').val(editingLog.price || 0);
                                $('#edit-operator').val(editingLog.operator || '');
                                $('#edit-destination').val(editingLog.destination || '');
                                $('#edit-location').val(editingLog.location || '');
                                $('#edit-remark').val(editingLog.remark || '');
                                $('#edit-modal').addClass('show');
                            }
                        }
                    }
                });
            };

            window.closeEditModal = function () {
                $('#edit-modal').removeClass('show');
                editingLog = null;
            };

            window.saveEdit = function () {
                if (!editingLog) return;

                // 验证必填字段
                var quantity = parseFloat($('#edit-quantity').val());
                if (!quantity || quantity <= 0) {
                    layer.msg('数量必须大于0', { icon: 2 });
                    return;
                }

                $.ajax({
                    url: '/api/v1/nursery/transaction/' + editingLog.id,
                    type: 'PUT',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        plant_name: $('#edit-plant-name').val(),
                        spec: $('#edit-spec').val(),
                        unit: $('#edit-unit').val(),
                        quantity: quantity,
                        price: parseFloat($('#edit-price').val()) || 0,
                        operator: $('#edit-operator').val(),
                        destination: $('#edit-destination').val(),
                        location: $('#edit-location').val(),
                        remark: $('#edit-remark').val()
                    }),
                    success: function (res) {
                        if (res.success) {
                            layer.msg('更新成功', { icon: 1 });
                            closeEditModal();
                            loadLogs();
                        } else {
                            layer.msg(res.msg || '更新失败', { icon: 2 });
                        }
                    },
                    error: function () {
                        layer.msg('网络请求失败', { icon: 2 });
                    }
                });
            };

            window.deleteLog = function (logId) {
                layer.confirm('确定要删除这条记录吗？<br><br><span style="color: #f97316;">⚠ 删除后不会回退库存</span>', {
                    title: '确认删除',
                    btn: ['确定删除', '取消']
                }, function (idx) {
                    $.ajax({
                        url: '/api/v1/nursery/transaction/' + logId,
                        type: 'DELETE',
                        success: function (res) {
                            if (res.success) {
                                layer.msg('删除成功', { icon: 1 });
                                layer.close(idx);
                                loadLogs();
                            } else {
                                layer.msg(res.msg || '删除失败', { icon: 2 });
                            }
                        },
                        error: function () {
                            layer.msg('网络请求失败', { icon: 2 });
                        }
                    });
                });
            };

            loadLogs();
        });
    </script>
</body>

</html>