<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>付款单</title>
  <link rel="stylesheet" href="/static/component/pear/css/pear.css" />
  <style>
    /* ==================== 统一设计规范 ==================== */
    :root {
      --primary-50: #eff6ff;
      --primary-500: #3b82f6;
      --primary-600: #2563eb;
      --slate-50: #f8fafc;
      --slate-100: #f1f5f9;
      --slate-200: #e2e8f0;
      --slate-300: #cbd5e1;
      --slate-500: #64748b;
      --slate-600: #475569;
      --slate-800: #1e293b;
      --slate-900: #0f172a;
      --white: #ffffff;
      --bg-body: var(--slate-100);
      --bg-card: var(--white);
      --border-color: var(--slate-200);
      --radius-sm: 4px;
      --radius-md: 8px;
      --radius-lg: 12px;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --ring-primary: 0 0 0 3px rgba(59, 130, 246, 0.2);
      --spacing-md: 16px;
      --spacing-lg: 24px;
    }

    body {
      background-color: var(--bg-body);
      padding: 20px;
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
    }

    .order-form-container {
      padding: var(--spacing-lg);
      background: var(--bg-card);
      max-width: 1200px;
      margin: 0 auto;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-md);
    }

    .main-title {
      text-align: center;
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 30px;
      color: var(--slate-900);
    }

    /* 通用区块样式 */
    .info-section {
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      padding: var(--spacing-lg);
      margin-bottom: 30px;
      position: relative;
      background: var(--slate-50);
    }

    .section-header {
      text-align: center;
      margin-bottom: 25px;
    }

    .section-title {
      font-size: 18px;
      font-weight: 600;
      display: inline-block;
      background: var(--slate-50);
      padding: 0 15px;
      color: var(--slate-800);
    }

    /* 网格布局 */
    .info-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px 60px;
    }

    .form-item {
      display: flex;
      align-items: center;
    }

    .form-item label {
      width: 110px;
      text-align: right;
      margin-right: 10px;
      color: var(--slate-600);
      font-size: 14px;
      white-space: nowrap;
    }

    .form-item .input-wrapper {
      flex: 1;
    }

    .form-item input,
    .form-item select,
    .layui-form-select {
      width: 100%;
      height: 38px;
      line-height: 38px;
      border: 1px solid var(--border-color);
      padding: 0 12px;
      box-sizing: border-box;
      border-radius: var(--radius-sm);
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    .form-item input:focus,
    .form-item select:focus {
      border-color: var(--primary-500);
      box-shadow: var(--ring-primary);
      outline: none;
    }

    /* 针对只读输入框的样式微调 */
    .form-item input[readonly] {
      background-color: var(--slate-100);
      border-color: var(--border-color);
    }

    /* 特殊：订单金额独占一行 */
    .form-item.full-width {
      grid-column: 1 / -1;
    }

    /* 多行文本框 */
    .form-item textarea {
      width: 100%;
      min-height: 100px;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      padding: 12px;
      box-sizing: border-box;
      resize: vertical;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    .form-item textarea:focus {
      border-color: var(--primary-500);
      box-shadow: var(--ring-primary);
      outline: none;
    }

    /* layui select 覆盖 */
    .layui-form-select .layui-input {
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      height: 38px;
    }

    .layui-form-select dl {
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      box-shadow: var(--shadow-md);
    }

    /* 底部按钮 */
    .form-actions {
      text-align: center;
      margin-top: 40px;
      padding-top: 20px;
      border-top: 1px solid var(--border-color);
    }

    .form-actions .layui-btn {
      min-width: 100px;
      height: 38px;
      line-height: 38px;
      border-radius: var(--radius-md);
      margin: 0 10px;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
    }

    .form-actions .layui-btn:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }

    .btn-cancel {
      background-color: var(--white);
      color: var(--slate-600);
      border: 1px solid var(--border-color);
    }

    .btn-cancel:hover {
      background-color: var(--slate-50);
      border-color: var(--slate-300);
    }

    .btn-confirm {
      background-color: var(--primary-500);
      color: var(--white);
      border: none;
    }

    .btn-confirm:hover {
      background-color: var(--primary-600);
    }
  </style>
</head>

<body>
  <div class="order-form-container layui-form">
    <div class="main-title">付款单</div>

    <!-- 订单信息摘要 -->
    <div class="info-section">
      <div class="section-header">
        <span class="section-title">订单信息摘要</span>
      </div>

      <div class="info-grid">
        <div class="form-item">
          <label>选择订单：</label>
          <div class="input-wrapper">
            <select name="order_id" lay-filter="order_select" id="order-select" lay-search>
              <option value="">请选择订单</option>
              <!-- 选项将通过JS加载 -->
            </select>
          </div>
        </div>

        <div class="form-item"></div> <!-- 占位保持对其 -->

        <div class="form-item">
          <label>关联订单编号：</label>
          <div class="input-wrapper">
            <input type="text" name="order_number" id="order-number" readonly autocomplete="off">
          </div>
        </div>

        <div class="form-item">
          <label>项目名称：</label>
          <div class="input-wrapper">
            <input type="text" name="project_name" readonly autocomplete="off">
          </div>
        </div>

        <div class="form-item">
          <label>材料名称：</label>
          <div class="input-wrapper">
            <input type="text" name="material_name" readonly autocomplete="off">
          </div>
        </div>


        <div class="form-item">
          <label>供应商联系人：</label>
          <div class="input-wrapper">
            <input type="text" name="supplier_contact_person" readonly autocomplete="off">
          </div>
        </div>

        <div class="form-item full-width">
          <label>订单金额：</label>
          <div class="input-wrapper">
            <input type="text" name="order_amount" readonly autocomplete="off">
          </div>
        </div>
      </div>
    </div>

    <!-- 付款单信息 -->
    <div class="info-section">
      <div class="section-header">
        <span class="section-title">付款单信息</span>
      </div>

      <div class="info-grid">
        <!-- 隐藏的ID字段 -->
        <input type="hidden" name="id" value="0">

        <div class="form-item">
          <label>付款单编号：</label>
          <div class="input-wrapper">
            <input type="text" name="pay_number" readonly value="" placeholder="自动生成" autocomplete="off">
          </div>
        </div>

        <div class="form-item">
          <label>付款单位：</label>
          <div class="input-wrapper">
            <select name="payer_supplier_id" id="payer-supplier-select" lay-search>
              <option value="">请选择付款单位</option>
            </select>
          </div>
        </div>

        <div class="form-item">
          <label>收款单位：</label>
          <div class="input-wrapper">
            <select name="payee_supplier_id" id="payee-supplier-select" lay-filter="payee_unit" lay-search>
              <option value="">请选择或输入</option>
            </select>
          </div>
        </div>

        <div class="form-item">
          <label>联系人：</label>
          <div class="input-wrapper">
            <input type="text" name="contact_person" id="contact-person" autocomplete="off">
          </div>
        </div>

        <div class="form-item">
          <label>联系电话：</label>
          <div class="input-wrapper">
            <input type="text" name="contact_phone" id="contact-phone" autocomplete="off">
          </div>
        </div>

        <div class="form-item">
          <label>开户行名称：</label>
          <div class="input-wrapper">
            <input type="text" name="bank_name" id="bank-name" autocomplete="off">
          </div>
        </div>

        <div class="form-item">
          <label>开户行账号：</label>
          <div class="input-wrapper">
            <input type="text" name="bank_account" id="bank-account" autocomplete="off">
          </div>
        </div>

        <div class="form-item">
          <label>本次付款金额：</label>
          <div class="input-wrapper">
            <input type="number" name="current_payment_amount" step="0.01" autocomplete="off">
          </div>
        </div>

        <div class="form-item">
          <label>开票金额：</label>
          <div class="input-wrapper">
            <input type="number" name="invoice_amount" step="0.01" placeholder="请输入开票金额" autocomplete="off">
          </div>
        </div>

        <div class="form-item">
          <label>付款状态：</label>
          <div class="input-wrapper">
            <select name="payment_status" id="payment-status-select">
              <option value="">请选择付款状态</option>
              <!-- 状态会从字典加载 -->
            </select>
          </div>
        </div>

        <div class="form-item">
          <label>经办人：</label>
          <div class="input-wrapper">
            <input type="text" name="handler" placeholder="请输入经办人" autocomplete="off">
          </div>
        </div>

        <div class="form-item full-width">
          <label>付款用途：</label>
          <div class="input-wrapper">
            <textarea name="payment_purpose"></textarea>
          </div>
        </div>

      </div>
    </div>

    <div class="form-actions">
      <button type="button" class="layui-btn btn-cancel" id="cancel-btn">取消</button>
      <button class="layui-btn btn-confirm" lay-submit lay-filter="save">确定</button>
    </div>
  </div>

  <script src="/static/component/layui/layui.js"></script>
  <script src="/static/component/pear/pear.js"></script>
  <script>
    layui.use(['form', 'jquery', 'layer'], function () {
      var form = layui.form;
      var $ = layui.jquery;
      var layer = layui.layer;

      // API 配置
      var API = {
        ORDER: "/api/v1/order/",
        PAY: "/api/v1/pay/",
        PAYER: "/api/v1/payer/",
        SUPPLIER: "/api/v1/supplier/",
        DICT: "/api/v1/dictionary/detail/list"
      };

      // 存储供应商数据，用于自动填充
      var supplierDataMap = {};
      // 当前支付单ID (如果存在)
      var currentPaymentId = null;

      // 获取URL参数
      var urlParams = new URLSearchParams(window.location.search);
      currentPaymentId = urlParams.get('payment_id');
      var initialOrderId = urlParams.get('order_id');
      var initialOrderNumber = urlParams.get('order_number');

      function makeRequest(options) {
        var defaults = {
          headers: {
            Authorization: "Bearer " + localStorage.getItem("access_token")
          },
          error: function (xhr) {
            console.error('Request failed:', xhr);
            layer.msg('请求失败: ' + (xhr.responseJSON ? xhr.responseJSON.msg : xhr.statusText), { icon: 2 });
          }
        };
        return $.ajax($.extend({}, defaults, options));
      }

      // 加载基础数据（字典、下拉选项）
      function initData() {
        // 1. 加载付款状态字典
        makeRequest({
          url: API.DICT,
          type: 'GET',
          data: { dic_id: 28, limit: 100 }, // fkzt
          success: function (res) {
            if (res.code === 0 && res.data) {
              var html = '<option value="">请选择付款状态</option>';
              res.data.forEach(function (item) {
                html += '<option value="' + item.code + '">' + item.value + '</option>';
              });
              $('#payment-status-select').html(html);
              form.render('select');
            }
          }
        });

        // 2. 加载付款单位
        makeRequest({
          url: API.PAYER,
          type: 'GET',
          data: { limit: 1000 },
          success: function (res) {
            if (res.code === 0 && res.data) {
              var html = '<option value="">请选择付款单位</option>';
              res.data.forEach(function (item) {
                html += '<option value="' + item.id + '">' + item.name + '</option>';
              });
              $('#payer-supplier-select').html(html);
              form.render('select');
            }
          }
        });

        // 3. 加载收款单位 (供应商)
        makeRequest({
          url: API.SUPPLIER,
          type: 'GET',
          data: { limit: 1000 },
          success: function (res) {
            if (res.code === 0 && res.data) {
              var html = '<option value="">请选择收款单位</option>';
              supplierDataMap = {};
              res.data.forEach(function (item) {
                html += '<option value="' + item.id + '">' + item.name + '</option>';
                supplierDataMap[item.id] = item;
              });
              $('#payee-supplier-select').html(html);
              form.render('select');

              // 数据加载完成后，如果还没加载具体付款单，尝试加载
              if (currentPaymentId) {
                loadPaymentDetails(currentPaymentId);
              } else if (initialOrderId) {
                // 如果是新建但有order_id，先加载orders下拉，再选中
                loadOrderList(function () {
                  $('#order-select').val(initialOrderId);
                  loadOrderInfo(initialOrderId);
                  form.render('select');
                });
                generatePaymentNo();
              } else {
                loadOrderList();
                generatePaymentNo();
              }
            }
          }
        });
      }

      // 加载订单列表
      function loadOrderList(callback) {
        makeRequest({
          url: API.ORDER,
          type: 'GET',
          data: { limit: 1000 },
          success: function (res) {
            if (res.code === 0 && res.data) {
              var html = '<option value="">请选择订单</option>';
              res.data.forEach(function (item) {
                html += '<option value="' + item.id + '">' + item.order_number + (item.project_name ? ' - ' + item.project_name : '') + '</option>';
              });
              $('#order-select').html(html);
              form.render('select');
              if (callback) callback();
            }
          }
        });
      }

      // 加载单个订单详情
      // savedPayeeId: 如果是编辑付款单，传入已保存的收款单位ID
      function loadOrderInfo(orderId, savedPayeeId) {
        if (!orderId) {
          resetOrderInfo();
          return;
        }
        makeRequest({
          url: API.ORDER + orderId,
          type: 'GET',
          success: function (res) {
            if (res.code === 0 && res.data) {
              var d = res.data;
              $('input[name="order_number"]').val(d.order_number || '');
              $('input[name="project_name"]').val(d.project_name || '');
              $('input[name="material_name"]').val(d.material_name || '');
              $('input[name="supplier_contact_person"]').val(d.supplier_contact_person || '');
              $('input[name="order_amount"]').val(d.order_amount || '');

              // 核心修改：根据供应商联系人从数据库获取相关供应商列表
              if (d.supplier_contact_person) {
                // 调用API获取该联系人关联的所有供应商
                makeRequest({
                  url: API.SUPPLIER,
                  type: 'GET',
                  data: {
                    contact_person: d.supplier_contact_person,
                    limit: 1000
                  },
                  success: function (supplierRes) {
                    if (supplierRes.code === 0 && supplierRes.data && supplierRes.data.length > 0) {
                      var html = '<option value="">请选择收款单位</option>';
                      supplierRes.data.forEach(function (supplier) {
                        html += '<option value="' + supplier.id + '">' + supplier.name + '</option>';
                        // 存储供应商数据用于自动填充
                        supplierDataMap[supplier.id] = supplier;
                      });
                      $('#payee-supplier-select').html(html);

                      // 优先使用已保存的收款单位ID（编辑时），否则使用订单关联的供应商ID（新建时）
                      var payeeToSelect = savedPayeeId || d.supplier_id;
                      if (payeeToSelect) {
                        $('#payee-supplier-select').val(payeeToSelect);
                        updateSupplierInfo(payeeToSelect);
                      }
                      form.render('select');
                    } else {
                      // 没有找到匹配的供应商
                      $('#payee-supplier-select').html('<option value="">未找到该联系人关联的供应商</option>');
                      updateSupplierInfo(null);
                      form.render('select');
                    }
                  },
                  error: function () {
                    $('#payee-supplier-select').html('<option value="">加载供应商失败</option>');
                    form.render('select');
                  }
                });
              } else {
                $('#payee-supplier-select').html('<option value="">该订单未设置供应商联系人</option>');
                updateSupplierInfo(null);
                form.render('select');
              }
            }
          }
        });
      }

      function resetOrderInfo() {
        $('input[name="order_number"]').val('');
        $('input[name="project_name"]').val('');
        $('input[name="material_name"]').val('');
        $('input[name="supplier"]').val('');
        $('input[name="order_amount"]').val('');
      }

      // 加载付款单详情
      function loadPaymentDetails(id) {
        var loading = layer.load(1);
        makeRequest({
          url: API.PAY + id,
          type: 'GET',
          success: function (res) {
            layer.close(loading);
            if (res.code === 0 && res.data) {
              var data = res.data;

              // 填充表单
              form.val('pay-info-form', {
                "id": data.id,
                "pay_number": data.pay_number,
                "payer_supplier_id": data.payer_supplier_id,
                "payee_supplier_id": data.payee_supplier_id,
                "current_payment_amount": data.current_payment_amount,
                "invoice_amount": data.invoice_amount,
                "payment_status": data.payment_status,
                "handler": data.handler,
                "payment_purpose": data.payment_purpose,
                "order_id": data.order_id
              });

              // 保存当前付款单的收款单位ID，用于后续选中
              var savedPayeeId = data.payee_supplier_id;

              // 手动设置一些没有自动匹配上的或者需要额外逻辑的
              if (data.order_id) {
                // 加载订单列表并选中当前订单
                loadOrderList(function () {
                  $('#order-select').val(data.order_id);
                  form.render('select');
                  // 加载订单详情，传入已保存的收款单位ID
                  loadOrderInfo(data.order_id, savedPayeeId);
                });
              } else {
                loadOrderList();
                // 如果没有订单，直接设置收款单位
                if (savedPayeeId && supplierDataMap[savedPayeeId]) {
                  updateSupplierInfo(savedPayeeId);
                }
              }
            }
          },
          error: function () {
            layer.close(loading);
          }
        });
      }

      function updateSupplierInfo(supplierId) {
        var s = supplierDataMap[supplierId];
        if (s) {
          $('#contact-person').val(s.contact_person || '');
          $('#contact-phone').val(s.phone || '');
          $('#bank-name').val(s.bank_name || '');
          $('#bank-account').val(s.account_number || '');
        } else {
          $('#contact-person').val('');
          $('#contact-phone').val('');
          $('#bank-name').val('');
          $('#bank-account').val('');
        }
      }

      // 生成临时编号
      function generatePaymentNo() {
        var now = new Date();
        var str = "P" + now.getFullYear() +
          String(now.getMonth() + 1).padStart(2, '0') +
          String(now.getDate()).padStart(2, '0') +
          String(Math.floor(Math.random() * 100000)).padStart(6, '0');
        $('input[name="pay_number"]').val(str);
      }

      // 事件监听

      // 监听订单选择
      form.on('select(order_select)', function (data) {
        loadOrderInfo(data.value);
      });

      // 监听收款单位选择
      form.on('select(payee_unit)', function (data) {
        updateSupplierInfo(data.value);
      });

      // 取消按钮
      $('#cancel-btn').click(function () {
        var index = parent.layer.getFrameIndex(window.name);
        if (index) {
          parent.layer.close(index);
        } else {
          window.history.back();
        }
      });

      // 表单提交
      form.on('submit(save)', function (data) {
        var field = data.field;
        var id = field.id;

        // 构建清理后的 payload，只包含后端需要的字段
        var payload = {
          id: (id && id !== "0") ? parseInt(id) : null,
          pay_number: field.pay_number,
          order_id: field.order_id ? parseInt(field.order_id) : null,
          payer_supplier_id: field.payer_supplier_id ? parseInt(field.payer_supplier_id) : null,
          payee_supplier_id: field.payee_supplier_id ? parseInt(field.payee_supplier_id) : null,
          current_payment_amount: field.current_payment_amount ? parseFloat(field.current_payment_amount) : 0,
          invoice_amount: field.invoice_amount ? parseFloat(field.invoice_amount) : 0,
          payment_status: field.payment_status,
          handler: field.handler,
          payment_purpose: field.payment_purpose
        };

        var method = (id && id !== "0") ? "PUT" : "POST";
        var url = API.PAY + ((id && id !== "0") ? id : "");

        makeRequest({
          url: url,
          type: method,
          contentType: "application/json",
          data: JSON.stringify(payload),
          success: function (res) {
            if (res.code === 0) {
              layer.msg('保存成功', { icon: 1, time: 1000 }, function () {
                var index = parent.layer.getFrameIndex(window.name);
                if (index) {
                  parent.layer.close(index);
                }
              });
            } else {
              layer.msg(res.msg || '保存失败', { icon: 2 });
            }
          }
        });
        return false;
      });

      // 给form添加filter以便form.val使用
      $('.layui-form').attr('lay-filter', 'pay-info-form');

      // 启动初始化
      initData();

    });
  </script>
</body>

</html>