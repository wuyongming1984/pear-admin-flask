<!doctype html>
<html lang="zh-cn">

<head>
  <meta charset="utf-8" />
  <title>订单管理</title>
  <meta name="renderer" content="webkit" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <style>
    /* ==================== 统一设计规范 ==================== */
    :root {
      /* 颜色体系 */
      --primary-50: #eff6ff;
      --primary-100: #dbeafe;
      --primary-500: #3b82f6;
      --primary-600: #2563eb;

      --slate-50: #f8fafc;
      --slate-100: #f1f5f9;
      --slate-200: #e2e8f0;
      --slate-300: #cbd5e1;
      --slate-400: #94a3b8;
      --slate-500: #64748b;
      --slate-600: #475569;
      --slate-800: #1e293b;
      --slate-900: #0f172a;

      --white: #ffffff;

      /* 语义化颜色 */
      --bg-body: var(--slate-100);
      --bg-card: var(--white);
      --text-main: var(--slate-800);
      --text-muted: var(--slate-500);
      --border-color: var(--slate-200);

      /* 圆角规范 */
      --radius-sm: 4px;
      --radius-md: 8px;
      --radius-lg: 12px;

      /* 阴影规范 */
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
      --ring-primary: 0 0 0 3px rgba(59, 130, 246, 0.2);

      /* 间距规范 */
      --spacing-xs: 4px;
      --spacing-sm: 8px;
      --spacing-md: 16px;
      --spacing-lg: 24px;
    }

    body {
      background-color: var(--bg-body);
      color: var(--text-main);
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      -webkit-font-smoothing: antialiased;
    }

    /* 卡片容器样式 */
    .layui-card {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-md);
      border: 1px solid var(--border-color);
      overflow: hidden;
      margin-bottom: 0;
    }

    .layui-card-header {
      border-bottom: 1px solid var(--border-color);
      padding: var(--spacing-md) var(--spacing-lg);
      font-size: 18px;
      font-weight: 600;
      color: var(--slate-900);
      background: var(--white);
    }

    .layui-card-body {
      padding: var(--spacing-lg);
    }

    /* 按钮样式 */
    .layui-btn {
      border-radius: var(--radius-md);
      font-weight: 500;
      box-shadow: var(--shadow-sm);
      transition: all 0.2s;
    }

    .layui-btn:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }

    /* 表格样式 */
    .layui-table-view {
      border: 1px solid var(--border-color) !important;
      border-radius: var(--radius-md);
    }

    .layui-table-header th {
      background-color: var(--slate-50) !important;
      color: var(--slate-600);
      font-weight: 600;
      border-color: var(--border-color) !important;
    }

    .layui-table-view .layui-table td {
      border-color: var(--border-color);
    }

    .layui-table-hover,
    .layui-table-body tr:hover {
      background-color: var(--primary-50) !important;
    }

    /* 筛选输入框 */
    .filter-input {
      border: 1px solid var(--border-color) !important;
      border-radius: var(--radius-md);
      background: var(--slate-50);
      transition: all 0.2s ease;
    }

    .filter-input:hover {
      background: var(--white);
      border-color: var(--slate-300) !important;
    }

    .filter-input:focus {
      background: var(--white);
      border-color: var(--primary-500) !important;
      box-shadow: var(--ring-primary);
      outline: none;
    }

    /* 操作列按钮间距 */
    .layui-table-cell .layui-btn-container {
      display: flex;
      gap: 5px;
      justify-content: center;
    }

    /* 确保表头和表体的列宽一致 - 根据内容自动调整 */
    .layui-table-view .layui-table-header table,
    .layui-table-view .layui-table-body table {
      width: 100% !important;
    }

    /* 如果表格有配置的列宽，使用 fixed 布局 */
    .layui-table-view.has-configured-width .layui-table-header table,
    .layui-table-view.has-configured-width .layui-table-body table {
      table-layout: fixed !important;
    }

    /* 如果没有配置列宽，使用 auto 布局 */
    .layui-table-view:not(.has-configured-width) .layui-table-header table,
    .layui-table-view:not(.has-configured-width) .layui-table-body table {
      table-layout: auto !important;
    }

    /* 确保列宽根据内容自动调整（仅在无配置宽度时） */
    .layui-table-view:not(.has-configured-width) .layui-table-header table colgroup col,
    .layui-table-view:not(.has-configured-width) .layui-table-body table colgroup col {
      width: auto !important;
    }

    /* 有配置宽度时，colgroup col 的宽度由JavaScript通过内联样式设置，不使用CSS */
    .layui-table-view .layui-table-header table thead th,
    .layui-table-view .layui-table-body table tbody td {
      padding: 5px 15px !important;
      white-space: nowrap;
    }

    /* 确保筛选输入框不影响列宽 */
    .filter-input-wrapper {
      width: 100%;
      box-sizing: border-box;
      min-width: 0;
    }

    .filter-input {
      width: 100%;
      box-sizing: border-box;
      min-width: 0;
    }

    /* 订单行样式 - 加粗加大 */
    .layui-table-body table tbody tr:not(.pay-child-row) td {
      font-weight: bold !important;
      font-size: 14px !important;
      color: #333 !important;
    }

    /* 付款单子行保持正常样式 */
    .layui-table-body table tbody tr.pay-child-row td {
      font-weight: normal;
      font-size: 13px;
    }

    /* 强制表格行高一致，解决固定列错位问题 */
    .layui-table-cell {
      height: 32px !important;
      line-height: 32px !important;
    }

    /* Sticky Operation Column */
    .layui-table-view .layui-table th:last-child,
    .layui-table-view .layui-table td:last-child {
      position: sticky;
      right: 0;
      background-color: #fff;
      z-index: 100;
      border-left: 1px solid #e6e6e6;
      /* Visual separator */
      box-shadow: -1px 0 5px rgba(0, 0, 0, 0.05);
      /* Subtle shadow */
    }

    /* Ensure header background matches */
    .layui-table-header th:last-child {
      background-color: #f2f2f2;
    }

    /* Ensure hover effect works on sticky column */
    .layui-table-hover td:last-child {
      background-color: #f2f2f2;
    }

    /* 附件上传样式 */
    .attachment-section {
      margin-top: 15px;
    }

    .attachment-upload {
      margin-bottom: 15px;
    }

    .attachment-list {
      border: 1px solid #e6e6e6;
      border-radius: 2px;
      padding: 10px;
      min-height: 100px;
      background: #fafafa;
    }

    .attachment-item {
      display: flex;
      align-items: center;
      padding: 10px;
      margin-bottom: 10px;
      background: #fff;
      border: 1px solid #e6e6e6;
      border-radius: 2px;
    }

    .attachment-item:last-child {
      margin-bottom: 0;
    }

    .attachment-item .file-icon {
      margin-right: 10px;
      font-size: 20px;
      color: #1E9FFF;
    }

    .attachment-item .file-info {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .attachment-item .file-code {
      font-size: 12px;
      color: #1E9FFF;
      font-weight: bold;
      margin-bottom: 3px;
    }

    .attachment-item .file-name {
      font-size: 14px;
      color: #333;
      margin-bottom: 3px;
    }

    .attachment-item .file-size {
      font-size: 12px;
      color: #999;
    }

    .attachment-item .file-actions {
      display: flex;
      gap: 10px;
    }

    .attachment-item .file-download,
    .attachment-item .file-delete {
      cursor: pointer;
      color: #1E9FFF;
      font-size: 14px;
    }

    .attachment-item .file-delete {
      color: #ff5722;
    }

    .attachment-item .file-download:hover {
      color: #009688;
    }

    .attachment-item .file-delete:hover {
      color: #f56c6c;
    }

    .attachment-empty {
      text-align: center;
      color: #999;
      padding: 20px;
      font-size: 14px;
    }

    /* 订单表单样式 */
    .order-form-container {
      padding: var(--spacing-lg);
      background: var(--bg-card);
      max-width: 1200px;
      margin: 0 auto;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-md);
    }

    #order-form-wrapper {
      display: none;
      padding: 20px 0;
    }

    #order-form-wrapper .order-form-container {
      display: block !important;
    }

    .form-title {
      text-align: center;
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 30px;
      padding-bottom: 10px;
      border-bottom: 2px solid var(--border-color);
      color: var(--slate-900);
    }

    .order-details-section {
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      padding: var(--spacing-md);
      margin-bottom: 20px;
      background: var(--slate-50);
    }

    .order-details-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px 30px;
    }

    .order-details-item {
      display: flex;
      align-items: center;
    }

    .order-details-item label {
      min-width: 100px;
      text-align: right;
      margin-right: 10px;
      font-weight: normal;
    }

    .order-details-item input,
    .order-details-item select {
      flex: 1;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      padding: 5px 8px;
      height: 36px;
      line-height: 36px;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    .order-details-item input:focus,
    .order-details-item select:focus {
      border-color: var(--primary-500);
      box-shadow: var(--ring-primary);
      outline: none;
    }

    .section-title {
      text-align: center;
      font-size: 18px;
      font-weight: 600;
      margin: 20px 0 15px 0;
      padding: 10px 0;
      border-top: none;
      border-bottom: 2px solid var(--border-color);
      color: var(--slate-800);
    }

    .material-details-section {
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      padding: var(--spacing-md);
      margin-bottom: 20px;
      background: var(--slate-50);
    }

    .material-description {
      display: flex;
      align-items: flex-start;
      margin-bottom: 15px;
    }

    .material-description label {
      min-width: 100px;
      text-align: right;
      margin-right: 10px;
      padding-top: 5px;
    }

    .material-description textarea {
      flex: 1;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      padding: 10px;
      min-height: 200px;
      resize: vertical;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    .material-description textarea:focus {
      border-color: var(--primary-500);
      box-shadow: var(--ring-primary);
      outline: none;
    }

    .financial-section {
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      padding: var(--spacing-md);
      margin-bottom: 20px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      background: var(--slate-50);
    }

    .financial-item {
      display: flex;
      align-items: center;
    }

    .financial-item label {
      min-width: 120px;
      text-align: right;
      margin-right: 10px;
    }

    .financial-item input {
      flex: 1;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      padding: 5px 8px;
      height: 36px;
      line-height: 36px;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    .financial-item input:focus {
      border-color: var(--primary-500);
      box-shadow: var(--ring-primary);
      outline: none;
    }

    .responsible-section {
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      padding: var(--spacing-md);
      margin-bottom: 20px;
      background: var(--slate-50);
    }

    .responsible-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px 30px;
      margin-top: 15px;
    }

    .responsible-item {
      display: flex;
      align-items: center;
    }

    .responsible-item label {
      min-width: 120px;
      text-align: right;
      margin-right: 10px;
    }

    .responsible-item input {
      flex: 1;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      padding: 5px 8px;
      height: 36px;
      line-height: 36px;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    .responsible-item input:focus {
      border-color: var(--primary-500);
      box-shadow: var(--ring-primary);
      outline: none;
    }

    .form-actions {
      margin-top: 30px;
      padding: 20px 0;
      text-align: center;
      border-top: 1px solid var(--border-color);
    }

    .form-actions .layui-btn {
      margin: 0 10px;
      min-width: 100px;
      border-radius: var(--radius-md);
    }
  </style>
</head>

<body>
  <div style="padding: 16px">
    <div class="layui-card">
      <div class="layui-card-body">
        <table class="layui-hide" id="order-table" lay-filter="order-table"></table>
      </div>
    </div>
  </div>
  <!-- 表单容器，放在表格下方 -->
  <div id="order-form-wrapper">
    <form class="layui-form order-form-container" lay-filter="order-form" id="order-form" action="">
      <!-- 隐藏字段 -->
      <input type="hidden" name="id" value="0" />
      <input type="hidden" name="attachments" id="attachments-data" />

      <!-- 表单标题 -->
      <div class="form-title">订单信息录入</div>

      <!-- 订单详情部分 -->
      <div class="order-details-section">
        <div class="order-details-grid">
          <div class="order-details-item">
            <label>订单编号：</label>
            <input type="text" name="order_number" placeholder="请输入订单编号" lay-verify="required" />
          </div>
          <div class="order-details-item">
            <label>下料时间：</label>
            <input type="text" name="cutting_time" id="form_cutting_time" placeholder="yyyy-MM-dd" />
          </div>
          <div class="order-details-item">
            <label>材料名称：</label>
            <select name="material_name" lay-search lay-verify="required">
              <option value="">请选择材料名称</option>
            </select>
          </div>
          <div class="order-details-item">
            <label>预计到场时间：</label>
            <input type="text" name="estimated_arrival_time" id="form_estimated_arrival_time"
              placeholder="yyyy-MM-dd" />
          </div>
          <div class="order-details-item">
            <label>项目名称：</label>
            <select name="project_name" lay-search>
              <option value="">请选择项目名称</option>
            </select>
          </div>
          <div class="order-details-item">
            <label>供应商联系人：</label>
            <select name="supplier_contact_person" id="supplier_contact_person" lay-search
              lay-filter="supplier_contact_person">
              <option value="">请选择供应商联系人</option>
            </select>
          </div>
          <div class="order-details-item">
            <label>供应商：</label>
            <select name="supplier_id" id="supplier_id" lay-search>
              <option value="">请选择供应商</option>
            </select>
          </div>
          <div class="order-details-item">
            <label>联系电话：</label>
            <input type="text" name="contact_phone" id="contact_phone" placeholder="联系电话将自动填充" readonly
              style="background-color: #f5f5f5;" />
          </div>
        </div>
      </div>

      <!-- 材料明细部分 -->
      <div class="section-title">材料明细</div>
      <div class="material-details-section">
        <div class="material-description">
          <label>内容描述：</label>
          <textarea name="material_details" placeholder="请输入材料明细"></textarea>
        </div>
        <div class="attachment-section">
          <div class="attachment-upload">
            <button type="button" class="layui-btn layui-btn-normal" id="upload-attachment">
              <i class="layui-icon layui-icon-upload"></i> 添加附件
            </button>
          </div>
          <div class="attachment-list" id="attachment-list">
            <div class="attachment-empty">暂无附件</div>
          </div>
        </div>
      </div>

      <!-- 财务信息部分 -->
      <div class="financial-section">
        <div class="financial-item">
          <label>订单金额：</label>
          <input type="number" name="order_amount" placeholder="请输入订单金额" step="0.01" />
        </div>
      </div>

      <!-- 负责人信息部分 -->
      <div class="section-title">负责人信息</div>
      <div class="responsible-section">
        <div class="responsible-grid">
          <div class="responsible-item">
            <label>材料负责人：</label>
            <input type="text" name="material_manager" placeholder="请输入材料负责人" />
          </div>
          <div class="responsible-item">
            <label>分项目负责人：</label>
            <input type="text" name="sub_project_manager" placeholder="请输入分项目负责人" />
          </div>
        </div>
      </div>

      <!-- 表单操作按钮 -->
      <div class="form-actions">
        <button type="button" class="layui-btn layui-btn-primary" id="cancel-btn">取消</button>
        <button type="submit" class="layui-btn" lay-submit lay-filter="order-form-btn">确定</button>
      </div>
    </form>
  </div>

  <!-- 付款单弹窗容器（从订单页面新增付款单） -->
  <!-- 已替换为 iframe 加载 pay_info.html，不再需要 pay_form.html -->

  <script type="text/html" id="order-toolbar">
      <div class="layui-btn-container">
        <button class="layui-btn layui-btn-sm" lay-event="order-toolbar-add">
          新增订单
        </button>
      </div>
    </script>
  <script type="text/html" id="order-tool">
      <div class="layui-btn-container">
        <button
          class="layui-btn layui-btn-sm layui-bg-blue"
          lay-event="order-tool-edit"
        >
          编辑
        </button>
        <button
          class="layui-btn layui-btn-sm layui-bg-orange"
          lay-event="order-tool-print"
        >
          打印订单
        </button>
        <button
          class="layui-btn layui-btn-sm layui-bg-green"
          lay-event="order-tool-pay"
        >
          新增付款单
        </button>
        <button
          class="layui-btn layui-btn-sm layui-bg-red"
          lay-event="order-tool-del"
        >
          删除
        </button>
      </div>
    </script>
  <script>
    layui.use(["table", "form", "layer", "laydate", "upload"], function () {
      var table = layui.table;
      var form = layui.form;
      var layer = layui.layer;
      var laydate = layui.laydate;
      var upload = layui.upload;
      var $ = layui.$;

      // 存储筛选条件
      var filterParams = {};
      // 筛选防抖定时器
      var filterTimer = null;

      // 存储附件列表
      var attachmentList = [];
      // 附件流水号计数器
      var attachmentSequence = 0;
      // 当前订单编号（用于生成附件编号）
      var currentOrderNumber = '';

      // 记录已展开的行ID，用于reloadTable后保持展开状态
      var expandedRowIds = new Set();

      // 初始化日期选择器
      laydate.render({
        elem: "#form_cutting_time",
        type: "date"
      });
      laydate.render({
        elem: "#form_estimated_arrival_time",
        type: "date"
      });

      // 格式化文件大小
      function formatFileSize(bytes) {
        if (bytes === 0) return '0 B';
        var k = 1024;
        var sizes = ['B', 'KB', 'MB', 'GB'];
        var i = Math.floor(Math.log(bytes) / Math.log(k));
        return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
      }

      // 获取文件图标
      function getFileIcon(fileName) {
        var ext = fileName.split('.').pop().toLowerCase();
        var iconMap = {
          'pdf': 'layui-icon-file-pdf',
          'doc': 'layui-icon-file',
          'docx': 'layui-icon-file',
          'xls': 'layui-icon-file-excel',
          'xlsx': 'layui-icon-file-excel',
          'ppt': 'layui-icon-file',
          'pptx': 'layui-icon-file',
          'jpg': 'layui-icon-picture',
          'jpeg': 'layui-icon-picture',
          'png': 'layui-icon-picture',
          'gif': 'layui-icon-picture',
          'zip': 'layui-icon-file',
          'rar': 'layui-icon-file',
          'txt': 'layui-icon-file',
          'dwg': 'layui-icon-file',
          'dgn': 'layui-icon-file',
          'dwf': 'layui-icon-file',
          'dxf': 'layui-icon-file'
        };
        return iconMap[ext] || 'layui-icon-file';
      }

      // 生成订单编号：D + 年月日(8位) + 序号(3位)
      // 格式：D20240101001
      function generateOrderNumber() {
        var now = new Date();
        var year = now.getFullYear();
        var month = String(now.getMonth() + 1).padStart(2, '0');
        var day = String(now.getDate()).padStart(2, '0');
        var dateStr = year + month + day; // 8位日期字符串

        // 使用时间戳的后3位作为序号，确保唯一性
        var timestamp = now.getTime();
        var sequence = String(timestamp % 1000).padStart(3, '0');

        return 'D' + dateStr + sequence;
      }

      // 生成附件编号：订单编号 + F + 三位流水号
      function generateAttachmentCode(orderNumber) {
        if (!orderNumber) {
          attachmentSequence++;
          var sequenceStr = String(attachmentSequence).padStart(3, '0');
          return 'TEMP' + 'F' + sequenceStr;
        }
        attachmentSequence++;
        var sequenceStr = String(attachmentSequence).padStart(3, '0');
        // 使用订单编号作为前缀
        var prefix = orderNumber.replace(/[^a-zA-Z0-9\u4e00-\u9fa5]/g, '');
        return prefix + 'F' + sequenceStr;
      }

      // 渲染附件列表
      function renderAttachmentList() {
        var $list = $('#attachment-list');
        if (attachmentList.length === 0) {
          $list.html('<div class="attachment-empty">暂无附件</div>');
          return;
        }
        var html = '';
        attachmentList.forEach(function (file, index) {
          html += '<div class="attachment-item" data-index="' + index + '">';
          html += '<i class="layui-icon ' + getFileIcon(file.name) + ' file-icon"></i>';
          html += '<div class="file-info">';
          // 显示附件编号
          if (file.code) {
            html += '<div class="file-code">附件编号：' + file.code + '</div>';
          }
          html += '<div class="file-name">' + (file.name || file.filename || '未知文件') + '</div>';
          html += '<div class="file-size">' + formatFileSize(file.size || 0) + '</div>';
          html += '</div>';
          html += '<div class="file-actions">';
          if (file.url) {
            html += '<span class="file-download" onclick="downloadAttachment(' + index + ')">下载</span>';
          }
          html += '<span class="file-delete" onclick="deleteAttachment(' + index + ')">删除</span>';
          html += '</div>';
          html += '</div>';
        });
        $list.html(html);
      }

      // 删除附件
      window.deleteAttachment = function (index) {
        layer.confirm('确定要删除这个附件吗？', { icon: 3, title: '提示' }, function (confirmIndex) {
          var file = attachmentList[index];
          // 如果附件已保存到数据库，调用API删除
          if (file.id) {
            $.ajax({
              url: window.location.origin + `/api/v1/attachment/${file.id}`,
              type: "DELETE",
              headers: {
                Authorization: "Bearer " + localStorage.getItem("access_token"),
              },
              success: function (res) {
                if (res.code === 0) {
                  attachmentList.splice(index, 1);
                  renderAttachmentList();
                  updateAttachmentsData();
                  layer.msg('删除成功', { icon: 1 });
                } else {
                  layer.msg(res.msg || '删除失败', { icon: 2 });
                }
                layer.close(confirmIndex);
              },
              error: function () {
                layer.msg('删除失败，请重试', { icon: 2 });
                layer.close(confirmIndex);
              }
            });
          } else {
            // 如果附件还未保存，直接从列表中移除
            attachmentList.splice(index, 1);
            renderAttachmentList();
            updateAttachmentsData();
            layer.close(confirmIndex);
          }
        });
      };

      // 下载附件
      window.downloadAttachment = function (index) {
        var file = attachmentList[index];
        if (file.url) {
          window.open(file.url, '_blank');
        } else if (file.blob) {
          var url = URL.createObjectURL(file.blob);
          var a = document.createElement('a');
          a.href = url;
          a.download = file.name;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        }
      };

      // 更新隐藏字段中的附件数据
      function updateAttachmentsData() {
        var attachmentsData = attachmentList.map(function (file) {
          return {
            id: file.id || null,
            code: file.code || '',
            name: file.name,
            url: file.url || '',
            size: file.size || 0,
            filename: file.filename || file.name
          };
        });
        $('#attachments-data').val(JSON.stringify(attachmentsData));
      }

      // 初始化文件上传
      upload.render({
        elem: '#upload-attachment',
        url: window.location.origin + '/api/v1/upload/',
        accept: 'file',
        multiple: true,
        headers: {
          Authorization: "Bearer " + localStorage.getItem("access_token")
        },
        data: function () {
          // 动态获取订单ID和附件编号
          var orderId = $('#order-form input[name="id"]').val();
          orderId = (orderId && orderId != '0') ? orderId : null;
          var orderNumber = $('#order-form input[name="order_number"]').val() || currentOrderNumber;
          var attachmentCode = generateAttachmentCode(orderNumber);
          return {
            project_id: orderId,  // 使用 project_id 字段，但实际是订单ID
            attachment_code: attachmentCode
          };
        },
        before: function (obj) {
          // 预读本地文件
          obj.preview(function (index, file, result) {
            // 获取订单编号用于生成附件编号
            var orderNumber = $('#order-form input[name="order_number"]').val() || currentOrderNumber;
            // 生成附件编号
            var attachmentCode = generateAttachmentCode(orderNumber);

            // 添加到附件列表
            var orderId = $('#order-form input[name="id"]').val();
            orderId = (orderId && orderId != '0') ? parseInt(orderId) : null;
            attachmentList.push({
              id: null,
              code: attachmentCode,
              name: file.name,
              size: file.size,
              blob: file,
              url: null,
              filename: null,
              orderId: orderId
            });
            renderAttachmentList();
            updateAttachmentsData();
          });
        },
        done: function (res, index, upload) {
          // 上传成功后的回调
          if (res.code === 0) {
            // 更新附件URL和文件名
            if (attachmentList[index]) {
              attachmentList[index].id = res.data.id || null;
              attachmentList[index].url = res.data.url || res.url;
              attachmentList[index].filename = res.data.filename || res.data.original_filename;
              attachmentList[index].size = res.data.size || attachmentList[index].size;
              // 如果附件编号是临时的，更新为正式编号
              if (attachmentList[index].code && attachmentList[index].code.startsWith('TEMP')) {
                var orderNumber = $('#order-form input[name="order_number"]').val() || currentOrderNumber;
                if (orderNumber) {
                  attachmentList[index].code = generateAttachmentCode(orderNumber);
                }
              }
            }
            renderAttachmentList();
            updateAttachmentsData();
            layer.msg('上传成功', { icon: 1 });
          } else {
            layer.msg(res.msg || '上传失败', { icon: 2 });
            // 移除失败的附件
            attachmentList.splice(index, 1);
            renderAttachmentList();
            updateAttachmentsData();
          }
        },
        error: function (index, upload) {
          // 上传失败的回调
          layer.msg('上传失败，请重试', { icon: 2 });
          attachmentList.splice(index, 1);
          renderAttachmentList();
          updateAttachmentsData();
        }
      });

      // 存储供应商数据，用于根据联系人查找供应商信息
      var suppliersData = [];

      // 存储材料名称映射（ID -> 名称）
      var materialNamesMap = {};

      // 加载项目列表（返回 Promise，用于等待加载完成）
      function loadProjects() {
        return new Promise(function (resolve) {
          $.ajax({
            url: window.location.origin + "/api/v1/project/",
            type: "GET",
            data: {
              limit: 1000  // 获取所有项目，不分页
            },
            headers: {
              Authorization: "Bearer " + localStorage.getItem("access_token"),
            },
            success: function (res) {
              if (res.code === 0 && res.data) {
                var html = '<option value="">请选择项目名称</option>';
                res.data.forEach(function (project) {
                  html += '<option value="' + project.project_name + '">' + project.project_name + '</option>';
                });
                $('select[name="project_name"]').html(html);
                form.render('select');
              }
              resolve();
            },
            error: function () {
              resolve();
            }
          });
        });
      }

      // 加载材料名称列表（从字典表，返回 Promise）
      function loadMaterialNames() {
        return new Promise(function (resolve) {
          $.ajax({
            url: window.location.origin + "/api/v1/dictionary/detail/list",
            type: "GET",
            data: {
              dic_id: 35,  // 材料名称代码字典的ID (clmc)
              limit: 1000  // 获取所有材料，不分页
            },
            headers: {
              Authorization: "Bearer " + localStorage.getItem("access_token"),
            },
            success: function (res) {
              if (res.code === 0 && res.data) {
                // 构建ID到名称的映射
                materialNamesMap = {};
                var html = '<option value="">请选择材料名称</option>';
                res.data.forEach(function (material) {
                  // 使用value作为option的value（材料名称文本）
                  html += '<option value="' + material.value + '">' + material.value + '</option>';
                  // 同时建立ID到名称的映射（用于显示旧数据）
                  materialNamesMap[material.id] = material.value;
                  materialNamesMap[material.code] = material.value;
                });
                $('select[name="material_name"]').html(html);
                form.render('select');
              }
              resolve();
            },
            error: function () {
              resolve();
            }
          });
        });
      }

      // 加载供应商列表和联系人列表（返回 Promise）
      function loadSuppliers() {
        return new Promise(function (resolve) {
          $.ajax({
            url: window.location.origin + "/api/v1/supplier/",
            type: "GET",
            data: {
              limit: 1000  // 获取所有供应商，不分页
            },
            headers: {
              Authorization: "Bearer " + localStorage.getItem("access_token"),
            },
            success: function (res) {
              if (res.code === 0 && res.data) {
                // 存储供应商数据
                suppliersData = res.data;

                // 加载供应商下拉框
                var supplierHtml = '<option value="">请选择供应商</option>';
                res.data.forEach(function (supplier) {
                  supplierHtml += '<option value="' + supplier.id + '" data-name="' + supplier.name + '" data-phone="' + supplier.phone + '">' + supplier.name + '</option>';
                });
                $('#supplier_id').html(supplierHtml);

                // 加载供应商联系人下拉框（去重）
                var contactPersonMap = {};
                var contactPersonHtml = '<option value="">请选择供应商联系人</option>';
                res.data.forEach(function (supplier) {
                  if (supplier.contact_person && !contactPersonMap[supplier.contact_person]) {
                    contactPersonMap[supplier.contact_person] = supplier;
                    contactPersonHtml += '<option value="' + supplier.contact_person + '" data-supplier-id="' + supplier.id + '" data-supplier-name="' + supplier.name + '" data-phone="' + supplier.phone + '">' + supplier.contact_person + '</option>';
                  }
                });
                $('#supplier_contact_person').html(contactPersonHtml);

                form.render('select');
              }
              resolve();
            },
            error: function () {
              resolve();
            }
          });
        });
      }

      // 加载供应商列表（用于付款单表单）
      function loadSuppliersForOrderPay() {
        $.ajax({
          url: window.location.origin + "/api/v1/supplier/",
          type: "GET",
          headers: {
            Authorization: "Bearer " + localStorage.getItem("access_token"),
          },
          success: function (res) {
            if (res.code === 0 && res.data) {
              var html = '<option value="">请选择供应商</option>';
              res.data.forEach(function (supplier) {
                html += '<option value="' + supplier.id + '">' + supplier.name + '</option>';
              });
              $('#order-pay-info-form select[name="payer_supplier_id"]').html(html);
              $('#order-pay-info-form select[name="payee_supplier_id"]').html(html);
              form.render('select');

              if (res.data.length === 0) {
                console.warn("加载供应商成功，但列表为空");
                // Optional: layer.msg("暂无供应商数据，请先维护供应商", {icon: 0});
              }
            } else {
              layer.msg(res.msg || '加载供应商列表失败', { icon: 2 });
            }
          },
          error: function (xhr, status, error) {
            console.error("加载供应商失败:", error);
            layer.msg('加载供应商失败: ' + (xhr.status || 'Unknown'), { icon: 2 });
          }
        });
      }

      loadSuppliers();
      loadMaterialNames();  // 加载材料名称列表

      // 列宽配置 - 可以根据需要修改各列的初始宽度（单位：px）
      var columnWidths = {
        'ID': 50,                    // ID列
        '订单编号': 50,             // 订单编号
        '材料名称': 150,             // 材料名称
        '材料明细': 200,             // 材料明细
        '项目名称': 150,             // 项目名称
        '供应商': 120,               // 供应商
        '供应商联系人': 120,         // 供应商联系人
        '订单金额': 120,             // 订单金额
        '订单余额': 120,             // 订单余额
        '材料负责人': 120,           // 材料负责人
        '关联付款单': 200            // 关联付款单
      };

      // 根据表头标题获取列宽配置
      function getColumnWidthByTitle($th) {
        // 从 .layui-table-cell 中获取纯文本，排除筛选输入框
        var $cell = $th.find('.layui-table-cell');
        var title;
        if ($cell.length) {
          // 克隆元素，移除所有子元素（包括筛选输入框），然后获取文本
          title = $cell.clone().children().remove().end().text().trim();
        } else {
          // 如果没有 .layui-table-cell，直接获取文本，但排除筛选输入框
          title = $th.clone().find('.filter-input-wrapper').remove().end().text().trim();
        }

        // 调试输出（可以在浏览器控制台查看）
        console.log('列标题:', title, '配置宽度:', columnWidths[title], '所有配置:', Object.keys(columnWidths));

        // 尝试精确匹配
        if (columnWidths[title]) {
          return columnWidths[title];
        }

        // 如果精确匹配失败，尝试去除所有空白字符后匹配
        var titleNoSpace = title.replace(/\s+/g, '');
        for (var key in columnWidths) {
          if (key.replace(/\s+/g, '') === titleNoSpace) {
            return columnWidths[key];
          }
        }

        return null; // 返回配置的宽度，如果没有配置则返回null
      }

      // 同步表头和表体的列宽 - 根据内容自动调整
      function syncColumnWidths() {
        var $tableView = $('.layui-table-view');
        var $headerTable = $tableView.find('.layui-table-header table');
        var $bodyTable = $tableView.find('.layui-table-body table');

        if ($headerTable.length && $bodyTable.length) {
          var $headerThs = $headerTable.find('thead tr th');
          var $headerCols = $headerTable.find('colgroup col');
          var $bodyCols = $bodyTable.find('colgroup col');

          // 确保 colgroup 存在
          if ($headerCols.length === 0) {
            var headerColgroup = $('<colgroup></colgroup>');
            $headerThs.each(function () {
              headerColgroup.append('<col>');
            });
            $headerTable.prepend(headerColgroup);
            $headerCols = $headerTable.find('colgroup col');
          }

          if ($bodyCols.length === 0) {
            var bodyColgroup = $('<colgroup></colgroup>');
            $headerThs.each(function () {
              bodyColgroup.append('<col>');
            });
            $bodyTable.prepend(bodyColgroup);
            $bodyCols = $bodyTable.find('colgroup col');
          }

          // 根据内容自动计算每列的最大宽度
          $headerThs.each(function (index) {
            var $headerTh = $(this);
            var configuredWidth = getColumnWidthByTitle($headerTh); // 获取配置的宽度
            var maxWidth;

            if (configuredWidth !== null && configuredWidth !== undefined) {
              // 如果配置了宽度，强制使用配置的宽度
              maxWidth = configuredWidth;
              console.log('使用配置宽度:', maxWidth, '列索引:', index);
            } else {
              // 如果没有配置，则根据内容自动计算
              maxWidth = $headerTh.outerWidth() || $headerTh.width() || 0;

              // 遍历表体中的所有行，找出该列的最大宽度
              $bodyTable.find('tbody tr').each(function () {
                var $td = $(this).find('td').eq(index);
                if ($td.length) {
                  // 临时移除宽度限制，获取实际内容宽度
                  var originalWidth = $td.css('width');
                  $td.css('width', 'auto');
                  var contentWidth = $td.outerWidth() || $td.width() || 0;
                  $td.css('width', originalWidth);

                  // 加上padding，确保有足够空间
                  var padding = parseInt($td.css('padding-left')) + parseInt($td.css('padding-right')) || 30;
                  var totalWidth = contentWidth + padding;

                  if (totalWidth > maxWidth) {
                    maxWidth = totalWidth;
                  }
                }
              });
              console.log('自动计算宽度:', maxWidth, '列索引:', index);
            }


            // 特殊处理：跳过“操作”列的宽度设置，让其自适应（弹性列）
            var columnTitle = getColumnWidthByTitle($headerTh); // 注意：这里有点重复调用，但为了复用逻辑
            // 为了准确判断，我们再次获取标题
            var titleText = $headerTh.text().trim();
            if (titleText.indexOf('操作') !== -1) {
              console.log('跳过操作列宽度设置，让其自适应');
              return; // 直接跳过此列的设置
            }

            // 设置列宽
            // 如果配置了宽度，强制应用（设置min-width和max-width）
            if (configuredWidth !== null && configuredWidth !== undefined) {
              // 设置 colgroup col 的宽度（使用 attr 和 style 双重设置确保生效）
              if ($headerCols.length > index) {
                var $headerCol = $headerCols.eq(index);
                $headerCol.attr('width', maxWidth);
                // 清理并设置样式
                var existingStyle = ($headerCol.attr('style') || '').replace(/width\s*:\s*[^;!]+;?/gi, '').replace(/min-width\s*:\s*[^;!]+;?/gi, '').replace(/max-width\s*:\s*[^;!]+;?/gi, '');
                $headerCol.attr('style', existingStyle + ' width: ' + maxWidth + 'px !important; min-width: ' + maxWidth + 'px !important; max-width: ' + maxWidth + 'px !important;');
              }
              if ($bodyCols.length > index) {
                var $bodyCol = $bodyCols.eq(index);
                $bodyCol.attr('width', maxWidth);
                // 清理并设置样式
                var existingStyle = ($bodyCol.attr('style') || '').replace(/width\s*:\s*[^;!]+;?/gi, '').replace(/min-width\s*:\s*[^;!]+;?/gi, '').replace(/max-width\s*:\s*[^;!]+;?/gi, '');
                $bodyCol.attr('style', existingStyle + ' width: ' + maxWidth + 'px !important; min-width: ' + maxWidth + 'px !important; max-width: ' + maxWidth + 'px !important;');
              }
              // 设置表头和表体的宽度（使用内联样式确保优先级）
              var headerExistingStyle = ($headerTh.attr('style') || '').replace(/width\s*:\s*[^;!]+;?/gi, '').replace(/min-width\s*:\s*[^;!]+;?/gi, '').replace(/max-width\s*:\s*[^;!]+;?/gi, '');
              $headerTh.attr('style', headerExistingStyle + ' width: ' + maxWidth + 'px !important; min-width: ' + maxWidth + 'px !important; max-width: ' + maxWidth + 'px !important;');

              $bodyTable.find('tbody tr td').eq(index).each(function () {
                var $td = $(this);
                var tdExistingStyle = ($td.attr('style') || '').replace(/width\s*:\s*[^;!]+;?/gi, '').replace(/min-width\s*:\s*[^;!]+;?/gi, '').replace(/max-width\s*:\s*[^;!]+;?/gi, '');
                $td.attr('style', tdExistingStyle + ' width: ' + maxWidth + 'px !important; min-width: ' + maxWidth + 'px !important; max-width: ' + maxWidth + 'px !important;');
              });
            } else {
              // 如果没有配置，使用自动调整
              if ($headerCols.length > index) {
                $headerCols.eq(index).css('width', maxWidth + 'px').attr('width', maxWidth);
              }
              if ($bodyCols.length > index) {
                $bodyCols.eq(index).css('width', maxWidth + 'px').attr('width', maxWidth);
              }
              $headerTh.css('width', maxWidth + 'px');
              $bodyTable.find('tbody tr td').eq(index).css('width', maxWidth + 'px');
            }
          });

          // 检查是否有配置的列宽
          var hasConfiguredWidth = false;
          $headerThs.each(function () {
            var $th = $(this);
            var width = getColumnWidthByTitle($th);
            if (width !== null && width !== undefined) {
              hasConfiguredWidth = true;
              return false; // 跳出循环
            }
          });

          // 根据是否有配置的列宽，添加或移除CSS类
          if (hasConfiguredWidth) {
            $tableView.addClass('has-configured-width');
            // 使用 fixed 布局以确保宽度生效（使用 !important）
            $headerTable.attr('style', ($headerTable.attr('style') || '') + ' table-layout: fixed !important;');
            $bodyTable.attr('style', ($bodyTable.attr('style') || '') + ' table-layout: fixed !important;');
          } else {
            $tableView.removeClass('has-configured-width');
            // 使用 auto 布局，让表格根据内容自动调整
            $headerTable.css('table-layout', 'auto');
            $bodyTable.css('table-layout', 'auto');
          }

          // 确保表格宽度为100%
          $headerTable.css('width', '100%');
          $bodyTable.css('width', '100%');

          // 如果有配置的宽度，强制重新应用一次（确保生效）
          if (hasConfiguredWidth) {
            setTimeout(function () {
              $headerThs.each(function (index) {
                var $headerTh = $(this);
                var configuredWidth = getColumnWidthByTitle($headerTh);
                if (configuredWidth !== null && configuredWidth !== undefined) {
                  var maxWidth = configuredWidth;
                  // 再次强制设置宽度
                  if ($headerCols.length > index) {
                    $headerCols.eq(index).attr('width', maxWidth).attr('style', 'width: ' + maxWidth + 'px !important; min-width: ' + maxWidth + 'px !important; max-width: ' + maxWidth + 'px !important;');
                  }
                  if ($bodyCols.length > index) {
                    $bodyCols.eq(index).attr('width', maxWidth).attr('style', 'width: ' + maxWidth + 'px !important; min-width: ' + maxWidth + 'px !important; max-width: ' + maxWidth + 'px !important;');
                  }
                  $headerTh.attr('style', 'width: ' + maxWidth + 'px !important; min-width: ' + maxWidth + 'px !important; max-width: ' + maxWidth + 'px !important;');
                  $bodyTable.find('tbody tr td').eq(index).attr('style', 'width: ' + maxWidth + 'px !important; min-width: ' + maxWidth + 'px !important; max-width: ' + maxWidth + 'px !important;');
                }
              });
            }, 50);
          }
        }
      }

      // 统一的表格重新加载函数
      function reloadTable(options) {
        options = options || {};
        var defaultOptions = {
          where: filterParams,
          done: function (res, curr, count) {
            addFilterInputs();
            setTimeout(function () {
              syncColumnWidths();

              // 恢复已展开的行
              if (res.data && expandedRowIds.size > 0) {
                // 遍历当前页的数据，找到对应的行索引
                // 注意： Layui table 的数据索引通常从 0 开始
                var data = res.data;
                for (var i = 0; i < data.length; i++) {
                  if (data[i].id && expandedRowIds.has(data[i].id)) {
                    // 找到对应的 TR 元素并触发点击
                    // Layui table body tr 具有 data-index 属性，对应数据索引
                    var $tr = $('div[lay-id="order-table"] .layui-table-body tr[data-index="' + i + '"]');
                    if ($tr.length > 0) {
                      // 触发点击事件以展开
                      // 注意：如果不判断当前是否已展开，直接点击会触发展开逻辑
                      // 因为 reload 后默认是收起的，所以直接点击即可
                      $tr.click();
                    }
                  }
                }
              }
            }, 100);
          }
        };
        var finalOptions = $.extend({}, defaultOptions, options);
        table.reload('order-table', finalOptions);
      }

      // 在表头添加筛选输入框
      function addFilterInputs() {
        setTimeout(function () {
          // 所有可筛选的字段配置
          var filterConfig = {
            'id': { type: 'text', placeholder: '筛选ID' },
            'order_number': {
              type: 'text',
              placeholder: '筛选订单编号',
              source: window.location.origin + "/api/v1/order/",
              labelField: 'order_number',
              valueField: 'order_number',
              unique: true
            },
            'material_name': {
              type: 'text',
              placeholder: '筛选材料名称',
              source: window.location.origin + "/api/v1/order/",
              labelField: 'material_name',
              valueField: 'material_name',
              unique: true
            },
            'project_name': {
              type: 'text',
              placeholder: '筛选项目名称',
              source: window.location.origin + "/api/v1/project/",
              labelField: 'project_name',
              valueField: 'project_name'
            },
            'supplier_name': {
              type: 'text',
              placeholder: '筛选供应商',
              source: window.location.origin + "/api/v1/supplier/",
              labelField: 'name',
              valueField: 'name'
            },
            'supplier_contact_person': {
              type: 'text',
              placeholder: '筛选供应商联系人',
              source: window.location.origin + "/api/v1/supplier/",
              labelField: 'contact_person',
              valueField: 'contact_person',
              unique: true
            },
            'order_amount': { type: 'text', placeholder: '筛选订单金额' },
            'material_manager': {
              type: 'text',
              placeholder: '筛选材料负责人',
              source: window.location.origin + "/api/v1/order/",
              labelField: 'material_manager',
              valueField: 'material_manager',
              unique: true
            }
          };

          Object.keys(filterConfig).forEach(function (field) {
            var $view = $('.layui-table-view[lay-id="order-table"]');
            var $th = $view.find('th[data-field="' + field + '"]');
            if ($th.length && !$th.find('.filter-input').length) {
              var config = filterConfig[field];
              var $filterDiv = $('<div class="filter-input-wrapper" style="margin-top: 5px;"></div>');
              var $input;

              if (config.type === 'date') {
                // 日期字段使用日期选择器
                $input = $('<input type="text" class="layui-input filter-input filter-date" placeholder="' + config.placeholder + '" data-field="' + field + '" style="height: 28px; font-size: 12px; padding: 0 8px;">');
                if (filterParams[field]) {
                  $input.val(filterParams[field]);
                }
                $filterDiv.append($input);
                // 初始化日期选择器
                setTimeout(function () {
                  laydate.render({
                    elem: $input[0],
                    type: 'date',
                    done: function (value) {
                      if (value) {
                        filterParams[field] = value;
                      } else {
                        delete filterParams[field];
                      }
                      clearTimeout(filterTimer);
                      filterTimer = setTimeout(function () {
                        reloadTable({
                          page: { curr: 1 }
                        });
                      }, 300);
                    }
                  });
                }, 50);
              } else {
                // 文本和数字字段，检查是否需要 Autocomplete (Source)
                var listId = config.source ? 'list-' + field : null;
                var listAttr = listId ? ' list="' + listId + '"' : '';

                $input = $('<input type="' + config.type + '" class="layui-input filter-input" placeholder="' + config.placeholder + '" data-field="' + field + '"' + listAttr + ' style="height: 28px; font-size: 12px; padding: 0 8px;">');
                if (filterParams[field]) {
                  $input.val(filterParams[field]);
                }
                $filterDiv.append($input);

                // 如果有 source，添加 datalist 和事件
                if (config.source) {
                  var $datalist = $('<datalist id="' + listId + '"></datalist>');
                  $filterDiv.append($datalist);

                  // 绑定 focus 事件加载数据
                  $input.on('focus', function () {
                    var $thisDatalist = $('#' + listId);
                    // 如果已经有数据，不再请求
                    if ($thisDatalist.children().length > 0) return;

                    $.ajax({
                      url: config.source,
                      type: 'GET',
                      data: { limit: 1000 }, // 获取足够多的数据
                      headers: {
                        Authorization: "Bearer " + localStorage.getItem("access_token"),
                      },
                      success: function (res) {
                        if (res.code === 0 && res.data) {
                          $thisDatalist.empty();
                          var items = res.data;
                          var validValues = new Set();

                          items.forEach(function (item) {
                            var val = item[config.valueField];
                            // 过滤空值
                            if (val) {
                              // 如果需要唯一性去重
                              if (config.unique) {
                                if (validValues.has(val)) return;
                                validValues.add(val);
                              }

                              var label = item[config.labelField] || val;
                              $thisDatalist.append('<option value="' + val + '">' + (label !== val ? label : '') + '</option>');
                            }
                          });
                        }
                      }
                    });
                  });
                }

                // 绑定 input 事件，更新 filterParams 并触发后端筛选
                (function (currentField) {
                  $input.on('input change', function () {
                    var value = $(this).val().trim();
                    if (value) {
                      filterParams[currentField] = value;
                    } else {
                      delete filterParams[currentField];
                    }
                    clearTimeout(filterTimer);
                    filterTimer = setTimeout(function () {
                      reloadTable({
                        page: { curr: 1 }
                      });
                    }, 500); // 500ms 防抖
                  });
                })(field);
              }

              $th.append($filterDiv);
            }
          });
          setTimeout(function () {
            syncColumnWidths();
          }, 50);
        }, 100);
      }

      // 渲染表格
      table.render({
        elem: "#order-table",
        id: "order-table",
        url: window.location.origin + "/api/v1/order/",
        headers: {
          Authorization: "Bearer " + localStorage.getItem("access_token"),
        },
        height: "full-35",
        toolbar: "#order-toolbar",
        page: true,
        limit: 90,
        defaultToolbar: ['filter', 'exports', 'print'],
        where: filterParams,
        cols: [
          [
            { field: "id", title: "ID", width: 60, sort: true, fixed: 'left', hide: true },
            {
              field: "order_number",
              title: "订单编号",
              width: 110,
              align: 'center'
            },
            {
              field: "material_name",
              title: "材料名称",
              width: 90,
              //minWidth: 90,
              align: 'center',
              templet: function (d) {
                var materialName = d.material_name;
                if (!materialName) return '-';

                // 检查是否为数字ID
                if (/^\d+$/.test(materialName)) {
                  // 尝试从映射表中查找
                  return materialNamesMap[materialName] || materialName;
                }

                // 直接返回文本
                return materialName;
              }
            },
            {
              field: "material_details",
              title: "材料明细",
              width: 200,
              align: 'left',
              hide: true,  // 默认隐藏，可在列显示设置中打开
              templet: function (d) {
                var details = d.material_details;
                if (!details || details.trim() === '') {
                  return '<span style="color: #999;">-</span>';
                }
                // 如果内容过长，截断显示并添加title提示
                if (details.length > 50) {
                  return '<span title="' + details + '">' + details.substring(0, 50) + '...</span>';
                }
                return details;
              }
            },
            {
              field: "supplier_name",
              title: "供应商",
              width: 120,
              hide: true
            },
            {
              field: "supplier_contact_person",
              title: "供应商联系人",
              width: 120,
              align: 'center'
            },
            {
              field: "order_amount",
              title: "金额",
              width: 110,
              sort: true,
              align: 'right'
            },
            {
              field: "order_balance",
              title: "余额",
              width: 110,
              sort: true,
              align: 'right',
              templet: function (d) {
                if (!d.order_balance) {
                  return '<span style="color: #999;">-</span>';
                }
                var balance = parseFloat(d.order_balance);
                var color = balance >= 0 ? '#5FB878' : '#FF5722'; // 正数绿色，负数红色
                return '<span style="color: ' + color + '; font-weight: bold;">¥' + balance.toFixed(2) + '</span>';
              }
            },
            {
              field: "material_manager",
              title: "负责人",
              width: 80,
              align: 'center'
            },
            {
              field: "pays_list",
              title: "付款单",
              width: 90,
              align: 'center',
              templet: function (d) {
                // 如果是订单行，显示付款单数量提示
                if (d.is_order) {
                  if (!d.pays_list || d.pays_list.length === 0) {
                    return '<span style="color: #999; font-size: 12px;">无</span>';
                  }
                  return '<span style="color: #1E9FFF; font-weight: bold;">' + d.pays_list.length + '笔</span>';
                }
                return '';
              }
            },
            {
              field: "project_name",
              title: "项目名称",
              minWidth: 50
            },
            {
              title: "操作",
              align: "center",
              toolbar: "#order-tool",
              minWidth: 200
            },
          ],
        ],
        done: function (res, curr, count) {
          addFilterInputs();
          // 多次同步列宽，确保完全同步
          setTimeout(function () {
            // syncColumnWidths();
            setTimeout(function () {
              // syncColumnWidths();
              // 默认不展开付款单子行，页面为收缩状态
              addPayRows();
            }, 100);
          }, 200);
        },
        parseData: function (res) {
          return {
            code: res.code,
            msg: res.msg,
            count: res.count,
            data: res.data,
          };
        }
      });

      // 为订单行添加付款单子行
      // 动态添加付款单详情行
      function addPayRows() {
        // 先移除所有已存在的子行，避免重复
        $('.pay-child-row').remove();

        var tableData = table.cache['order-table'];
        if (!tableData) return;

        // 根据当前表格显示的列结构手动构建子行
        // 当前显示列（9列）：[1]没有(隐藏) [2]订单编号 [3]材料 [4]供应商(隐藏) [5]联系人 [6]金额 [7]余额 [8]负责人 [9]付款单 [10]项目 [11]操作
        // 实际可见索引：
        // 0: Order No
        // 1: Material
        // 2: Contact
        // 3: Amount
        // 4: Balance
        // 5: Manager
        // 6: Pays List
        // 7: Project
        // 8: Operation

        tableData.forEach(function (data, index) {
          if (!data.is_order || !data.pays_list || data.pays_list.length === 0) return;

          var $tr = $('div[lay-id="order-table"] .layui-table-main tr[data-index="' + index + '"]');
          if ($tr.length === 0) return;

          // 为每个付款单创建子行
          data.pays_list.forEach(function (pay, index) {
            var statusColor = '';
            var statusText = '';
            if (pay.payment_status === 'paid') {
              statusColor = '#5FB878';
              statusText = '已付款';
            } else if (pay.payment_status === 'partial') {
              statusColor = '#FFB800';
              statusText = '部分付款';
            } else {
              statusColor = '#FF5722';
              statusText = '待付款';
            }

            var payRowHtml = '<tr class="pay-child-row" data-pay-id="' + pay.id + '" style="background-color: #fbfcff; border-top: 1px solid #eee; display: none;">';

            // 1. 订单编号列 (仅显示结构线)
            payRowHtml += '<td style="text-align: right; color: #ddd; padding-right: 15px; border-right: none;">└─</td>';

            // 2. 材料名称列 (空)
            payRowHtml += '<td style="border-left: none;"></td>';

            // 3. 联系人列 (空)
            payRowHtml += '<td></td>';

            // 4-8. 合并详情列 (colspan=5: 金额, 余额, 负责人, 付款单, 项目)
            payRowHtml += '<td colspan="5" style="padding-left: 20px;">';
            payRowHtml += '<div style="display: flex; align-items: center; gap: 20px; flex-wrap: wrap;">';

            // 付款单编号
            payRowHtml += '<span style="color: #333; font-weight: bold; min-width: 120px;">' + (pay.pay_number || '无编号') + '</span>';

            // 金额
            payRowHtml += '<span style="color: #1E9FFF; font-weight: bold; font-family: monospace; font-size: 14px;">¥' + (pay.current_payment_amount ? parseFloat(pay.current_payment_amount).toFixed(2) : '0.00') + '</span>';

            // 付款单位
            if (pay.payer_supplier_name) {
              payRowHtml += '<span style="color: #666;">付款单位: <span style="color: #333;">' + pay.payer_supplier_name + '</span></span>';
            }

            // 状态
            payRowHtml += '<span style="padding: 2px 6px; border-radius: 2px; font-size: 12px; color: #fff; background-color: ' + statusColor + ';">' + statusText + '</span>';

            // 经办人
            if (pay.handler) {
              payRowHtml += '<span style="color: #999; font-size: 12px;">经办人: ' + pay.handler + '</span>';
            }

            payRowHtml += '</div>';
            payRowHtml += '</td>';

            // 9. 操作列
            payRowHtml += '<td style="text-align: center;">';
            payRowHtml += '<button type="button" class="layui-btn layui-btn-xs layui-btn-normal edit-pay-btn" data-pay-id="' + pay.id + '" data-order-id="' + data.id + '">编辑</button>';
            payRowHtml += '<button type="button" class="layui-btn layui-btn-xs layui-bg-orange print-pay-btn" data-pay-id="' + pay.id + '" data-order-id="' + data.id + '" style="margin-left: 5px;">打印</button>';
            payRowHtml += '</td>';

            payRowHtml += '</tr>';

            $tr.after(payRowHtml);
          });
        });
      }

      // 监听表格行点击，展开/折叠付款单
      table.on('row(order-table)', function (obj) {
        var data = obj.data;
        if (!data.is_order || !data.pays_list || data.pays_list.length === 0) return;

        var $tr = obj.tr;
        // 找到属于当前订单的所有子行（直到下一个订单行或表格结束）
        var $childRows = $tr.nextUntil('tr:not(.pay-child-row)', '.pay-child-row');
        // 获取付款单列的单元格内容元素
        var $payCountCell = $tr.find('td[data-field="pays_list"] .layui-table-cell');

        if ($childRows.length > 0) {
          // 如果子行已存在，则切换显示/隐藏
          $childRows.toggle();
          // 根据子行是否显示，切换父行付款单数量显示的可见性
          if ($childRows.is(':visible')) {
            $payCountCell.css('visibility', 'hidden');
            expandedRowIds.add(data.id);
          } else {
            $payCountCell.css('visibility', 'visible');
            expandedRowIds.delete(data.id);
          }
        } else {
          // 如果子行不存在，则添加并显示
          addPayRows();
          // 重新获取子行并显示
          setTimeout(function () {
            var $newChildRows = $tr.nextUntil('tr:not(.pay-child-row)', '.pay-child-row');
            $newChildRows.show();
            // 展开后隐藏父行数量显示
            $payCountCell.css('visibility', 'hidden');
            expandedRowIds.add(data.id);
          }, 50);
        }
      });

      // 打印订单函数 - 样式与编辑订单页面一致
      function printOrder(orderData) {
        // 创建打印内容，样式与编辑页面一致
        var printContent = '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>订单打印</title>';
        printContent += '<style>';
        // 屏幕预览样式
        printContent += 'body{font-family: "Microsoft YaHei", Arial, sans-serif; padding: 20px; background: #fff; max-width: 1200px; margin: 0 auto; line-height: 1.4;}';
        printContent += '.form-title{text-align: center; font-size: 24px; font-weight: bold; margin-bottom: 30px; padding-bottom: 10px; border-bottom: 2px solid #000;}';

        // 表格样式
        printContent += '.info-table{border-collapse: collapse; width: 100%; margin-bottom: 15px;}';
        printContent += '.info-table th, .info-table td{border: 1px solid #000; padding: 8px; text-align: left;}';
        printContent += '.info-table .section-header{background-color: #f0f0f0; font-weight: bold; font-size: 16px; text-align: center;}';
        printContent += '.info-table .label{background-color: #f8f8f8; font-weight: bold; width: 120px; text-align: right; padding-right: 12px;}';
        printContent += '.info-table .value{background-color: #fff; padding-left: 12px;}';

        // 关联付款单表格样式（保留）
        printContent += 'table{border-collapse: collapse; width: 100%; margin-top: 10px;}';
        printContent += 'table th, table td{border: 1px solid #000; padding: 8px; text-align: left;}';
        printContent += 'table th{background-color: #f0f0f0; font-weight: bold;}';

        // 打印样式 - 竖向打印在A4纸上半部分
        printContent += '@media print{';
        printContent += 'body{padding: 5mm; margin: 0; max-width: 100%; line-height: 1.2; height: 148.5mm; overflow: hidden;}';
        printContent += '@page{size: A4 portrait; margin: 8mm 10mm 0 10mm;}';
        printContent += '.form-title{font-size: 18px; margin-bottom: 3mm; padding-bottom: 2mm; line-height: 1.2;}';

        // 打印时的表格样式
        printContent += '.info-table{margin-bottom: 2mm;}';
        printContent += '.info-table th, .info-table td{font-size: 9px; padding: 1mm 2mm; line-height: 1.2;}';
        printContent += '.info-table .section-header{font-size: 10px; padding: 1.5mm 2mm;}';
        printContent += '.info-table .label{width: 80px; font-size: 9px; padding-right: 2mm;}';
        printContent += '.info-table .value{font-size: 9px; padding-left: 2mm;}';

        printContent += 'table th, table td{font-size: 8px; padding: 1mm; line-height: 1.2;}';
        printContent += '}</style></head><body>';

        // 表单标题
        printContent += '<div class="form-title">订单信息录入</div>';

        // 订单详情表格
        printContent += '<table class="info-table">';
        printContent += '<thead><tr><th colspan="4" class="section-header">订单详情</th></tr></thead>';
        printContent += '<tbody>';
        printContent += '<tr>';
        printContent += '<td class="label">订单编号</td>';
        printContent += '<td class="value">' + (orderData.order_number || '-') + '</td>';
        printContent += '<td class="label">下料时间</td>';
        printContent += '<td class="value">' + (orderData.cutting_time || '-') + '</td>';
        printContent += '</tr>';
        printContent += '<tr>';
        printContent += '<td class="label">材料名称</td>';
        printContent += '<td class="value">' + (orderData.material_name || '-') + '</td>';
        printContent += '<td class="label">预计到场时间</td>';
        printContent += '<td class="value">' + (orderData.estimated_arrival_time || '-') + '</td>';
        printContent += '</tr>';
        printContent += '<tr>';
        printContent += '<td class="label">项目名称</td>';
        printContent += '<td class="value">' + (orderData.project_name || '-') + '</td>';
        printContent += '<td class="label">供应商联系人</td>';
        printContent += '<td class="value">' + (orderData.supplier_contact_person || '-') + '</td>';
        printContent += '</tr>';
        printContent += '<tr>';
        printContent += '<td class="label">供应商</td>';
        printContent += '<td class="value">' + (orderData.supplier_name || '-') + '</td>';
        printContent += '<td class="label">联系电话</td>';
        printContent += '<td class="value">' + (orderData.contact_phone || '-') + '</td>';
        printContent += '</tr>';
        printContent += '</tbody>';
        printContent += '</table>';

        // 材料明细表格
        printContent += '<table class="info-table" style="margin-top: 15px;">';
        printContent += '<thead><tr><th colspan="4" class="section-header">材料明细</th></tr></thead>';
        printContent += '<tbody>';
        printContent += '<tr>';
        printContent += '<td class="label" style="width: 100px;">内容描述</td>';
        printContent += '<td class="value" colspan="3" style="white-space: pre-wrap; min-height: 100px; vertical-align: top; padding: 8px;">' + (orderData.material_details || '-') + '</td>';
        printContent += '</tr>';
        printContent += '</tbody>';
        printContent += '</table>';

        // 财务信息表格
        printContent += '<table class="info-table" style="margin-top: 15px;">';
        printContent += '<thead><tr><th colspan="4" class="section-header">财务信息</th></tr></thead>';
        printContent += '<tbody>';
        printContent += '<tr>';
        printContent += '<td class="label">订单金额</td>';
        printContent += '<td class="value">¥' + (orderData.order_amount ? parseFloat(orderData.order_amount).toFixed(2) : '0.00') + '</td>';
        printContent += '<td class="label">订单余额</td>';
        printContent += '<td class="value">¥' + (orderData.order_balance ? parseFloat(orderData.order_balance).toFixed(2) : '0.00') + '</td>';
        printContent += '</tr>';
        printContent += '</tbody>';
        printContent += '</table>';

        // 负责人信息表格
        printContent += '<table class="info-table" style="margin-top: 15px;">';
        printContent += '<thead><tr><th colspan="4" class="section-header">负责人信息</th></tr></thead>';
        printContent += '<tbody>';
        printContent += '<tr>';
        printContent += '<td class="label">材料负责人</td>';
        printContent += '<td class="value">' + (orderData.material_manager || '-') + '</td>';
        printContent += '<td class="label">分项目负责人</td>';
        printContent += '<td class="value">' + (orderData.sub_project_manager || '-') + '</td>';
        printContent += '</tr>';
        printContent += '</tbody>';
        printContent += '</table>';

        // 关联付款单（如果有）
        if (orderData.pays_list && orderData.pays_list.length > 0) {
          printContent += '<div class="section-title">关联付款单</div>';
          printContent += '<div style="border: 1px solid #000; padding: 2mm; margin-bottom: 2mm;">';
          printContent += '<table><thead><tr><th>付款单编号</th><th>付款金额</th><th>付款状态</th><th>经办人</th><th>付款单位</th></tr></thead><tbody>';
          orderData.pays_list.forEach(function (pay) {
            printContent += '<tr>';
            printContent += '<td>' + (pay.pay_number || '-') + '</td>';
            printContent += '<td>¥' + (pay.current_payment_amount ? parseFloat(pay.current_payment_amount).toFixed(2) : '0.00') + '</td>';
            printContent += '<td>' + (pay.payment_status || '-') + '</td>';
            printContent += '<td>' + (pay.handler || '-') + '</td>';
            printContent += '<td>' + (pay.payer_supplier_name || '-') + '</td>';
            printContent += '</tr>';
          });
          printContent += '</tbody></table></div>';
        }

        printContent += '</body></html>';

        // 打开新窗口并打印
        var printWindow = window.open('', '_blank');
        printWindow.document.write(printContent);
        printWindow.document.close();
        printWindow.onload = function () {
          setTimeout(function () {
            printWindow.print();
          }, 250);
        };
      }

      // 打印付款单函数
      function printPay(payData, orderData, supplierData) {
        // 创建打印内容，样式与编辑页面一致
        var printContent = '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>付款单打印</title>';
        printContent += '<style>';
        // 屏幕预览样式
        printContent += 'body{font-family: "Microsoft YaHei", Arial, sans-serif; padding: 20px; background: #fff; max-width: 1200px; margin: 0 auto; line-height: 1.4;}';
        printContent += '.form-title{text-align: center; font-size: 24px; font-weight: bold; margin-bottom: 30px; padding-bottom: 10px; border-bottom: 2px solid #000;}';

        // 表格样式
        printContent += '.info-table{border-collapse: collapse; width: 100%; margin-bottom: 15px;}';
        printContent += '.info-table th, .info-table td{border: 1px solid #000; padding: 8px; text-align: left;}';
        printContent += '.info-table .section-header{background-color: #f0f0f0; font-weight: bold; font-size: 16px; text-align: center;}';
        printContent += '.info-table .label{background-color: #f8f8f8; font-weight: bold; width: 120px; text-align: right; padding-right: 12px;}';
        printContent += '.info-table .value{background-color: #fff; padding-left: 12px;}';

        // 打印样式
        printContent += '@media print{';
        printContent += 'body{padding: 5mm; margin: 0; max-width: 100%; line-height: 1.2; height: 148.5mm; overflow: hidden;}';
        printContent += '@page{size: A4 portrait; margin: 8mm 10mm 0 10mm;}';
        printContent += '.form-title{font-size: 18px; margin-bottom: 3mm; padding-bottom: 2mm; line-height: 1.2;}';
        printContent += '.info-table{margin-bottom: 2mm;}';
        printContent += '.info-table th, .info-table td{font-size: 9px; padding: 1mm 2mm; line-height: 1.2;}';
        printContent += '.info-table .section-header{font-size: 10px; padding: 1.5mm 2mm;}';
        printContent += '.info-table .label{width: 80px; font-size: 9px; padding-right: 2mm;}';
        printContent += '.info-table .value{font-size: 9px; padding-left: 2mm;}';
        printContent += '}</style></head><body>';

        // 表单标题
        printContent += '<div class="form-title">付款单</div>';

        // 订单信息摘要表格（如果有）
        if (orderData) {
          printContent += '<table class="info-table">';
          printContent += '<thead><tr><th colspan="4" class="section-header">订单信息摘要</th></tr></thead>';
          printContent += '<tbody>';
          printContent += '<tr>';
          printContent += '<td class="label">关联订单编号</td>';
          printContent += '<td class="value">' + (orderData.order_number || '-') + '</td>';
          printContent += '<td class="label">项目名称</td>';
          printContent += '<td class="value">' + (orderData.project_name || '-') + '</td>';
          printContent += '</tr>';
          printContent += '<tr>';
          printContent += '<td class="label">材料名称</td>';
          printContent += '<td class="value">' + (orderData.material_name || '-') + '</td>';
          printContent += '<td class="label">供应商</td>';
          printContent += '<td class="value">' + (orderData.supplier_name || '-') + '</td>';
          printContent += '</tr>';
          printContent += '<tr>';
          printContent += '<td class="label">订单金额</td>';
          printContent += '<td class="value" colspan="3">¥' + (orderData.order_amount ? parseFloat(orderData.order_amount).toFixed(2) : '0.00') + '</td>';
          printContent += '</tr>';
          printContent += '</tbody>';
          printContent += '</table>';
        }

        // 付款单信息表格
        printContent += '<table class="info-table">';
        printContent += '<thead><tr><th colspan="4" class="section-header">付款单信息</th></tr></thead>';
        printContent += '<tbody>';

        // 付款状态文本转换
        var paymentStatusText = '';
        if (payData.payment_status === 'paid') {
          paymentStatusText = '已付款';
        } else if (payData.payment_status === 'partial') {
          paymentStatusText = '部分付款';
        } else {
          paymentStatusText = '待付款';
        }

        printContent += '<tr>';
        printContent += '<td class="label">付款单编号</td>';
        printContent += '<td class="value">' + (payData.pay_number || '-') + '</td>';
        printContent += '<td class="label">付款单位</td>';
        printContent += '<td class="value">' + (payData.payer_supplier_name || '-') + '</td>';
        printContent += '</tr>';

        printContent += '<tr>';
        printContent += '<td class="label">收款单位</td>';
        printContent += '<td class="value">' + (payData.payee_supplier_name || '-') + '</td>';
        printContent += '<td class="label">付款状态</td>';
        printContent += '<td class="value">' + paymentStatusText + '</td>';
        printContent += '</tr>';

        // 新增：联系人与电话
        var contactPerson = supplierData ? (supplierData.contact_person || '-') : '-';
        var contactPhone = supplierData ? (supplierData.phone || '-') : '-';
        printContent += '<tr>';
        printContent += '<td class="label">联系人</td>';
        printContent += '<td class="value">' + contactPerson + '</td>';
        printContent += '<td class="label">联系电话</td>';
        printContent += '<td class="value">' + contactPhone + '</td>';
        printContent += '</tr>';

        // 新增：开户行与账号
        var bankName = supplierData ? (supplierData.bank_name || '-') : '-';
        var bankAccount = supplierData ? (supplierData.account_number || '-') : '-';
        printContent += '<tr>';
        printContent += '<td class="label">开户行名称</td>';
        printContent += '<td class="value">' + bankName + '</td>';
        printContent += '<td class="label">开户行账号</td>';
        printContent += '<td class="value">' + bankAccount + '</td>';
        printContent += '</tr>';

        printContent += '<tr>';
        printContent += '<td class="label">本次付款金额</td>';
        printContent += '<td class="value">¥' + (payData.current_payment_amount ? parseFloat(payData.current_payment_amount).toFixed(2) : '0.00') + '</td>';
        printContent += '<td class="label">开票金额</td>';
        printContent += '<td class="value">¥' + (payData.invoice_amount ? parseFloat(payData.invoice_amount).toFixed(2) : '0.00') + '</td>';
        printContent += '</tr>';

        printContent += '<tr>';
        printContent += '<td class="label">经办人</td>';
        printContent += '<td class="value" colspan="3">' + (payData.handler || '-') + '</td>';
        printContent += '</tr>';

        printContent += '<tr>';
        printContent += '<td class="label" style="vertical-align: top;">付款用途</td>';
        printContent += '<td class="value" colspan="3" style="white-space: pre-wrap; min-height: 80px; vertical-align: top; padding: 8px;">' + (payData.payment_purpose || '-') + '</td>';
        printContent += '</tr>';
        printContent += '</tbody>';
        printContent += '</table>';

        printContent += '</body></html>';

        // 打开新窗口并打印
        var printWindow = window.open('', '_blank');
        printWindow.document.write(printContent);
        printWindow.document.close();
        printWindow.onload = function () {
          setTimeout(function () {
            printWindow.print();
          }, 250);
        };
      }

      // 监听打印付款单按钮点击
      $(document).on('click', '.print-pay-btn', function (e) {
        e.stopPropagation(); // 阻止事件冒泡

        var payId = $(this).data('pay-id');

        if (!payId) {
          layer.msg('付款单ID不存在', { icon: 2 });
          return;
        }

        // 加载付款单详情
        $.ajax({
          url: window.location.origin + `/api/v1/pay/${payId}`,
          type: 'GET',
          headers: {
            Authorization: "Bearer " + localStorage.getItem("access_token"),
          },
          success: function (res) {
            if (res.code === 0 && res.data) {
              var payData = res.data;
              var orderData = null;
              var supplierData = null;

              // 使用 Promise 链式调用，以便支持 fallback 逻辑
              var fetchOrder = function () {
                var def = $.Deferred();
                if (payData.order_id) {
                  $.ajax({
                    url: window.location.origin + `/api/v1/order/${payData.order_id}`,
                    type: 'GET',
                    headers: { Authorization: "Bearer " + localStorage.getItem("access_token") },
                    success: function (res) {
                      if (res.code === 0) orderData = res.data;
                      def.resolve();
                    },
                    error: function () { def.resolve(); }
                  });
                } else {
                  def.resolve();
                }
                return def.promise();
              };

              fetchOrder().then(function () {
                var supplierId = payData.payee_supplier_id;
                // Fallback: 如果付款单没有记录收款单位，尝试使用订单的供应商
                if (!supplierId && orderData && orderData.supplier_id) {
                  console.log('Using Order Supplier ID as fallback:', orderData.supplier_id);
                  supplierId = orderData.supplier_id;
                }

                if (supplierId) {
                  console.log('Fetching supplier info for ID:', supplierId);
                  $.ajax({
                    url: window.location.origin + `/api/v1/supplier/${supplierId}`,
                    type: 'GET',
                    headers: { Authorization: "Bearer " + localStorage.getItem("access_token") },
                    success: function (res) {
                      console.log('Supplier Fetch Result:', res);
                      if (res.code === 0) supplierData = res.data;
                      printPay(payData, orderData, supplierData);
                    },
                    error: function (xhr, status, err) {
                      console.error('Supplier Fetch Error:', err);
                      // 即使获取失败，也尝试打印（没有供应商详情）
                      printPay(payData, orderData, null);
                    }
                  });
                } else {
                  console.warn('No supplier ID found (checked payee_supplier_id and order fallback)');
                  printPay(payData, orderData, null);
                }
              });
            } else {
              layer.msg(res.msg || '获取付款单信息失败', { icon: 2 });
            }
          },
          error: function () {
            layer.msg('获取付款单信息失败，请重试', { icon: 2 });
          }
        });
      });

      // 监听付款单编辑按钮点击
      $(document).off('click', '.edit-pay-btn').on('click', '.edit-pay-btn', function (e) {
        e.stopPropagation(); // 阻止事件冒泡，避免触发行点击事件

        var payId = $(this).data('pay-id');
        var orderId = $(this).data('order-id');

        if (!payId) {
          layer.msg('付款单ID不存在', { icon: 2 });
          return;
        }

        var payUrl = '/order_pay/info/pay_info.html?payment_id=' + payId +
          (orderId ? '&order_id=' + orderId : '');

        layer.open({
          type: 2,
          title: '编辑付款单',
          shade: 0.1,
          area: ['90%', '90%'],
          content: payUrl,
          end: function () {
            reloadTable();
          }
        });
      });

      // 监听订单编号输入，动态更新附件编号
      $(document).on('input', '#order-form input[name="order_number"]', function () {
        currentOrderNumber = $(this).val() || '';
        attachmentList.forEach(function (file) {
          if (file.code && file.code.startsWith('TEMP')) {
            file.code = generateAttachmentCode(currentOrderNumber);
          }
        });
        renderAttachmentList();
        updateAttachmentsData();
      });

      // 监听供应商联系人选择，自动填充供应商名称和联系电话
      form.on('select(supplier_contact_person)', function (data) {
        console.log('供应商联系人选择事件触发', data);
        var contactPerson = data.value;
        if (contactPerson) {
          // 查找对应的供应商信息
          var selectedOption = $('#supplier_contact_person option:selected');
          var supplierId = selectedOption.attr('data-supplier-id');
          var supplierName = selectedOption.attr('data-supplier-name');
          var phone = selectedOption.attr('data-phone');

          console.log('找到供应商信息:', { supplierId: supplierId, supplierName: supplierName, phone: phone });

          if (supplierId) {
            // 设置供应商ID
            $('#supplier_id').val(supplierId);
            form.render('select');

            // 设置联系电话
            if (phone) {
              $('#contact_phone').val(phone);
            } else {
              // 如果选项中没有电话，从存储的供应商数据中查找
              var supplier = suppliersData.find(function (s) {
                return s.id == supplierId;
              });
              if (supplier && supplier.phone) {
                $('#contact_phone').val(supplier.phone);
              }
            }

            layer.msg('已自动填充供应商和联系电话', { icon: 1, time: 1500 });
          } else {
            layer.msg('未找到对应的供应商信息', { icon: 2 });
          }
        } else {
          // 清空供应商和联系电话
          $('#supplier_id').val('');
          $('#contact_phone').val('');
          form.render('select');
        }
      });

      // 监听表格工具栏事件
      table.on('toolbar(order-table)', function (obj) {
        if (obj.event === 'order-toolbar-add') {
          console.log('新增订单按钮被点击');
          $("#order-form")[0].reset();
          $("#order-form input[name='id']").val(0);
          // 清空附件列表和重置计数器
          attachmentList = [];
          attachmentSequence = 0;
          currentOrderNumber = '';
          renderAttachmentList();
          updateAttachmentsData();
          loadProjects();  // 加载项目列表
          loadSuppliers();  // 加载供应商列表和联系人列表
          loadMaterialNames();  // 加载材料名称列表

          // 自动生成订单编号
          var orderNumber = generateOrderNumber();
          $("#order-form input[name='order_number']").val(orderNumber);
          currentOrderNumber = orderNumber;

          // 自动填入当前日期到下料时间
          var now = new Date();
          var year = now.getFullYear();
          var month = String(now.getMonth() + 1).padStart(2, '0');
          var day = String(now.getDate()).padStart(2, '0');
          var currentDate = year + '-' + month + '-' + day;
          // 先设置输入框的值
          $("#order-form input[name='cutting_time']").val(currentDate);

          // 使用 layer 弹窗显示表单
          layer.open({
            type: 1,
            title: false,
            closeBtn: 1,
            shadeClose: true,
            shade: false,  // 不显示遮罩层
            area: ['90%', '90%'],
            content: $("#order-form-wrapper"),
            success: function (layero, index) {
              // 弹窗打开后，确保表单可见
              $("#order-form-wrapper").show();
              form.render($("#order-form"));
              // 重新初始化日期选择器，并设置默认值为当前日期
              laydate.render({
                elem: layero.find("#form_cutting_time"),
                type: "date",
                value: currentDate  // 设置默认值为当前日期
              });
              laydate.render({
                elem: layero.find("#form_estimated_arrival_time"),
                type: "date"
              });
            },
            end: function () {
              // 弹窗关闭后隐藏表单容器
              $("#order-form-wrapper").hide();
            }
          });
        }
      });

      // 监听行工具事件
      table.on('tool(order-table)', function (obj) {
        var data = obj.data;
        if (obj.event === 'order-tool-edit') {
          console.log('编辑订单按钮被点击', data);

          // 使用 Promise.all 等待所有下拉框数据加载完成后再设置表单值
          Promise.all([loadProjects(), loadSuppliers(), loadMaterialNames()]).then(function () {
            // 处理材料名称：如果是ID，则转换为对应的名称
            if (data.material_name && /^\d+$/.test(data.material_name)) {
              var mappedName = materialNamesMap[data.material_name];
              if (mappedName) {
                data.material_name = mappedName;
              }
            }
            form.val("order-form", data);

            // 设置供应商联系人（如果存在）
            if (data.supplier_contact_person) {
              $('#supplier_contact_person').val(data.supplier_contact_person);
              form.render('select');

              // 触发联系人选择事件，自动填充供应商和联系电话
              var contactPersonOption = $('#supplier_contact_person option[value="' + data.supplier_contact_person + '"]');
              if (contactPersonOption.length > 0) {
                var supplierId = contactPersonOption.attr('data-supplier-id');
                var phone = contactPersonOption.attr('data-phone');
                if (supplierId) {
                  $('#supplier_id').val(supplierId);
                  $('#contact_phone').val(phone || data.contact_phone || '');
                  form.render('select');
                }
              }
            } else if (data.supplier_id) {
              // 如果没有联系人，但有供应商ID，直接设置供应商
              $('#supplier_id').val(data.supplier_id);
              form.render('select');
            }
          });

          // 设置当前订单编号
          currentOrderNumber = data.order_number || '';
          // 重置附件计数器
          attachmentSequence = 0;

          // 加载附件数据
          attachmentList = [];
          var attachments = null;

          // 优先使用 attachments_list（从数据库加载）
          if (data.attachments_list && Array.isArray(data.attachments_list) && data.attachments_list.length > 0) {
            attachments = data.attachments_list;
          } else if (data.attachments) {
            // 兼容旧的 JSON 字符串格式
            try {
              attachments = JSON.parse(data.attachments);
            } catch (e) {
              console.error('解析附件数据失败:', e);
            }
          }

          if (attachments && Array.isArray(attachments) && attachments.length > 0) {
            attachmentList = attachments.map(function (file) {
              return {
                id: file.id || null,
                code: file.code || generateAttachmentCode(currentOrderNumber),
                name: file.name || file.original_filename || file.filename || '未知文件',
                url: file.url || file.file_path || '',
                size: file.size || file.file_size || 0,
                filename: file.filename || file.name || ''
              };
            });
            // 更新计数器到最大值
            attachmentList.forEach(function (file) {
              if (file.code && file.code.includes('F')) {
                var parts = file.code.split('F');
                if (parts.length > 1) {
                  var seq = parseInt(parts[parts.length - 1]) || 0;
                  if (seq > attachmentSequence) {
                    attachmentSequence = seq;
                  }
                }
              }
            });
          }
          renderAttachmentList();
          updateAttachmentsData();

          // 使用 layer 弹窗显示表单
          layer.open({
            type: 1,
            title: false,
            closeBtn: 1,
            shadeClose: true,
            shade: false,  // 不显示遮罩层
            area: ['90%', '90%'],
            content: $("#order-form-wrapper"),
            success: function (layero, index) {
              // 弹窗打开后，确保表单可见
              $("#order-form-wrapper").show();
              form.render($("#order-form"));
              // 重新初始化日期选择器
              laydate.render({
                elem: layero.find("#form_cutting_time"),
                type: "date"
              });
              laydate.render({
                elem: layero.find("#form_estimated_arrival_time"),
                type: "date"
              });
            },
            end: function () {
              // 弹窗关闭后隐藏表单容器
              $("#order-form-wrapper").hide();
            }
          });
        } else if (obj.event === 'order-tool-print') {
          // 打印订单
          console.log('打印订单按钮被点击', data);
          printOrder(data);
        } else if (obj.event === 'order-tool-pay') {
          // 新增付款单 - 弹出弹窗并自动填充订单信息
          console.log('新增付款单按钮被点击', data);

          var payUrl = '/order_pay/info/pay_info.html?order_id=' + data.id +
            (data.order_number ? '&order_number=' + encodeURIComponent(data.order_number) : '');

          layer.open({
            type: 2,
            title: '新增付款单',
            shade: 0.1,
            area: ['90%', '90%'],
            content: payUrl,
            end: function () {
              reloadTable();
            }
          });
        } else if (obj.event === 'order-tool-del') {
          layer.confirm('确定要删除这个订单吗？', { icon: 3, title: '提示' }, function (confirmIndex) {
            $.ajax({
              url: window.location.origin + `/api/v1/order/${data.id}`,
              type: "DELETE",
              contentType: "application/json",
              headers: {
                Authorization: "Bearer " + localStorage.getItem("access_token"),
              },
              success: function (res) {
                if (res.code === 0) {
                  layer.msg(res.msg, { icon: 1 });
                  reloadTable();
                } else {
                  layer.msg(res.msg || '删除失败', { icon: 2 });
                }
                layer.close(confirmIndex);
              },
              error: function () {
                layer.msg('删除失败，请重试', { icon: 2 });
                layer.close(confirmIndex);
              }
            });
          });
        }
      });

      // 监听单元格编辑
      table.on('edit(order-table)', function (obj) {
        var value = obj.value;
        var data = obj.data;
        var field = obj.field;

        var updateData = {};
        updateData[field] = value;
        updateData.id = data.id;

        $.ajax({
          url: window.location.origin + `/api/v1/order/${data.id}`,
          type: "PUT",
          contentType: "application/json",
          data: JSON.stringify(updateData),
          headers: {
            Authorization: "Bearer " + localStorage.getItem("access_token"),
          },
          success: function (res) {
            if (res.code === 0) {
              layer.msg('更新成功', { icon: 1, time: 1000 });
            } else {
              layer.msg(res.msg || '更新失败', { icon: 2 });
              reloadTable();
            }
          },
          error: function () {
            layer.msg('更新失败，请重试', { icon: 2 });
            reloadTable();
          }
        });
      });

      // 表单提交
      form.on("submit(order-form-btn)", function (data) {
        var field = data.field;

        // 验证必填字段
        if (!field.order_number || field.order_number.trim() === '') {
          layer.msg('订单编号不能为空', { icon: 2 });
          return false;
        }
        if (!field.material_name || field.material_name.trim() === '') {
          layer.msg('材料名称不能为空', { icon: 2 });
          return false;
        }

        let method, url;
        if (field.id == 0 || field.id == '0') {
          field.id = null;
          method = "POST";
          url = window.location.origin + "/api/v1/order/";
        } else {
          method = "PUT";
          url = window.location.origin + `/api/v1/order/${field.id}`;
        }

        // 移除 supplier_contact_person 字段（该字段仅用于前端选择，不提交到后端）
        delete field.supplier_contact_person;

        // 处理订单金额（确保是数字或null）
        if (field.order_amount) {
          var amount = parseFloat(field.order_amount);
          field.order_amount = isNaN(amount) ? null : amount;
        } else {
          field.order_amount = null;
        }

        // 处理供应商ID（确保是整数或null）
        if (field.supplier_id) {
          var supplierId = parseInt(field.supplier_id);
          field.supplier_id = isNaN(supplierId) ? null : supplierId;
        } else {
          field.supplier_id = null;
        }

        // 处理附件数据，转换为JSON字符串
        updateAttachmentsData();
        field.attachments = $('#attachments-data').val() || JSON.stringify([]);

        // 调试信息
        console.log('提交订单数据:', field);

        $.ajax({
          url: url,
          type: method,
          contentType: "application/json",
          data: JSON.stringify(field),
          headers: {
            Authorization: "Bearer " + localStorage.getItem("access_token"),
          },
          success: function (res) {
            if (res && res.code === 0) {
              layer.msg(res.msg || '操作成功', { icon: 1 });
              // 关闭弹窗
              layer.closeAll();
              // 清空附件列表
              attachmentList = [];
              renderAttachmentList();
              updateAttachmentsData();
              reloadTable();
            } else {
              var errorMsg = (res && res.msg) ? res.msg : '操作失败';
              layer.msg(errorMsg, { icon: 2 });
              console.error('订单操作失败:', res);
            }
          },
          error: function (xhr, status, error) {
            var errorMsg = '操作失败，请重试';
            if (xhr.responseJSON && xhr.responseJSON.msg) {
              errorMsg = xhr.responseJSON.msg;
            } else if (xhr.responseText) {
              try {
                var errorData = JSON.parse(xhr.responseText);
                if (errorData.msg) {
                  errorMsg = errorData.msg;
                }
              } catch (e) {
                errorMsg = '网络错误，请检查连接';
              }
            }
            layer.msg(errorMsg, { icon: 2 });
            console.error('订单操作错误:', status, error, xhr);
          }
        });
        return false;
      });

      // 监听筛选栏输入，实现模糊搜索
      $(document).on('input', '.filter-input:not(.filter-date)', function () {
        var $input = $(this);
        var field = $input.data('field');
        var value = $input.val().trim();

        if (value) {
          filterParams[field] = value;
        } else {
          delete filterParams[field];
        }

        clearTimeout(filterTimer);
        filterTimer = setTimeout(function () {
          reloadTable({
            page: {
              curr: 1
            }
          });
        }, 1200);
      });

      // 取消按钮事件
      $(document).on('click', '#cancel-btn', function () {
        layer.closeAll();
        $("#order-form")[0].reset();
        attachmentList = [];
        attachmentSequence = 0;
        currentOrderNumber = '';
        renderAttachmentList();
        updateAttachmentsData();
      });

      // 订单付款单表单提交
      form.on("submit(order-pay-info-form-btn)", function (data) {
        var field = data.field;

        // 验证必填字段
        if (!field.order_id) {
          layer.msg('订单ID不能为空', { icon: 2 });
          return false;
        }
        if (!field.pay_number) {
          layer.msg('请输入付款单编号', { icon: 2 });
          return false;
        }
        if (!field.payer_supplier_id) {
          layer.msg('请选择付款单位', { icon: 2 });
          return false;
        }
        if (!field.payee_supplier_id) {
          layer.msg('请选择收款单位', { icon: 2 });
          return false;
        }
        if (!field.current_payment_amount) {
          layer.msg('请输入本次付款金额', { icon: 2 });
          return false;
        }

        // 判断是新增还是编辑
        var method, url;
        if (field.id && field.id != 0) {
          // 编辑付款单
          method = "PUT";
          url = window.location.origin + `/api/v1/pay/${field.id}`;
        } else {
          // 创建付款单
          method = "POST";
          url = window.location.origin + "/api/v1/pay/";
          delete field.id; // 删除id字段，让后端自动生成
        }

        // 处理金额字段
        if (field.current_payment_amount) {
          field.current_payment_amount = parseFloat(field.current_payment_amount) || field.current_payment_amount;
        }
        if (field.invoice_amount) {
          field.invoice_amount = parseFloat(field.invoice_amount) || field.invoice_amount;
        }

        $.ajax({
          url: url,
          type: method,
          contentType: "application/json",
          data: JSON.stringify(field),
          headers: {
            Authorization: "Bearer " + localStorage.getItem("access_token"),
          },
          success: function (res) {
            if (res.code === 0) {
              layer.msg(res.msg, { icon: 1 });
              layer.closeAll();
              // 重新加载表格以显示更新后的付款单信息
              reloadTable();
            } else {
              layer.msg(res.msg || '操作失败', { icon: 2 });
            }
          },
          error: function () {
            layer.msg('操作失败，请重试', { icon: 2 });
          }
        });
        return false;
      });

      // 订单付款单取消按钮
      $(document).on('click', '#order-pay-info-cancel-btn', function () {
        layer.closeAll();
      });
    });
  </script>
</body>

</html>