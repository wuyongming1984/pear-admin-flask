<!doctype html>
<html lang="zh-cn">

<head>
    <meta charset="utf-8" />
    <title>付款单位管理</title>
    <meta name="renderer" content="webkit" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <style>
        /* 操作列按钮间距 */
        .layui-table-cell .layui-btn-container {
            display: flex;
            gap: 5px;
            justify-content: center;
        }

        /* 确保表头和表体的列宽一致 - 根据内容自动调整 */
        .layui-table-view .layui-table-header table,
        .layui-table-view .layui-table-body table {
            table-layout: auto !important;
            width: 100% !important;
        }

        /* 确保列宽根据内容自动调整 */
        .layui-table-view .layui-table-header table colgroup col,
        .layui-table-view .layui-table-body table colgroup col {
            width: auto !important;
        }

        .layui-table-view .layui-table-header table thead th,
        .layui-table-view .layui-table-body table tbody td {
            padding: 9px 15px !important;
            white-space: nowrap;
        }

        /* 确保筛选输入框不影响列宽 */
        .filter-input-wrapper {
            width: 100%;
            box-sizing: border-box;
            min-width: 0;
        }

        .filter-input {
            width: 100%;
            box-sizing: border-box;
            min-width: 0;
        }
    </style>
</head>

<body>
    <div style="padding: 16px">
        <div class="layui-card">
            <div class="layui-card-body">
                <table class="layui-hide" id="payer-table" lay-filter="payer-table"></table>
            </div>
        </div>
    </div>
    <form class="layui-form" lay-filter="payer-form" id="payer-form" action="" style="padding: 15px; display: none">
        <div class="layui-form-item">
            <label class="layui-form-label">ID</label>
            <div class="layui-input-block">
                <input type="text" name="id" value="0" lay-verify="required" autocomplete="off" class="layui-input"
                    disabled />
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">付款单位类型</label>
            <div class="layui-input-block">
                <input type="number" name="type_id" placeholder="请输入付款单位类型(1:单位, 2:个人)" lay-verify="required"
                    autocomplete="off" class="layui-input" />
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">付款单位名称</label>
            <div class="layui-input-block">
                <input type="text" name="name" placeholder="请输入付款单位名称" lay-verify="required" autocomplete="off"
                    class="layui-input" />
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">开户行名称</label>
            <div class="layui-input-block">
                <input type="text" name="bank_name" placeholder="请输入开户行名称" autocomplete="off" class="layui-input" />
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">银行账号</label>
            <div class="layui-input-block">
                <input type="text" name="account_number" placeholder="请输入银行账号" autocomplete="off" class="layui-input" />
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">备注</label>
            <div class="layui-input-block">
                <textarea name="remark" placeholder="请输入备注" class="layui-textarea"></textarea>
            </div>
        </div>
        <div class="layui-form-item">
            <div class="layui-input-block">
                <button type="submit" class="layui-btn" lay-submit lay-filter="payer-form-btn">
                    立即提交
                </button>
                <button type="reset" class="layui-btn layui-btn-primary">重置</button>
            </div>
        </div>
    </form>
    <script type="text/html" id="payer-toolbar">
      <div class="layui-btn-container">
        <button class="layui-btn layui-btn-sm" lay-event="payer-toolbar-add">
          新增付款单位
        </button>
      </div>
    </script>
    <script type="text/html" id="payer-tool">
      <div class="layui-btn-container">
        <button
          class="layui-btn layui-btn-sm layui-bg-blue"
          lay-event="payer-tool-edit"
        >
          编辑
        </button>
        <button
          class="layui-btn layui-btn-sm layui-bg-red"
          lay-event="payer-tool-del"
        >
          删除
        </button>
      </div>
    </script>
    <script>
        layui.use(["table", "form", "layer"], function () {
            var table = layui.table;
            var form = layui.form;
            var layer = layui.layer;
            var $ = layui.$;

            // 存储筛选条件
            var filterParams = {};

            // 渲染表格
            table.render({
                elem: "#payer-table",
                id: "payer-table",
                url: window.location.origin + "/api/v1/payer/",
                height: "full-35",
                toolbar: "#payer-toolbar",
                page: true,
                headers: {
                    Authorization: "Bearer " + localStorage.getItem("access_token"),
                },
                defaultToolbar: ['filter', 'exports', 'print'],
                where: filterParams,
                cols: [
                    [
                        { field: "id", title: "ID", sort: true },
                        {
                            field: "name",
                            title: "付款单位名称",
                            edit: 'text'
                        },
                        {
                            field: "type_id",
                            title: "类型",
                            templet: function (d) {
                                return d.type_id == 1 ? '单位' : (d.type_id == 2 ? '个人' : d.type_id);
                            },
                            edit: 'text'
                        },
                        {
                            field: "bank_name",
                            title: "开户行名称",
                            edit: 'text'
                        },
                        {
                            field: "account_number",
                            title: "银行账号",
                            edit: 'text'
                        },
                        {
                            field: "remark",
                            title: "备注",
                            edit: 'text'
                        },
                        {
                            field: "create_at",
                            title: "创建时间",
                            sort: true
                        },
                        {
                            title: "操作",
                            align: "center",
                            toolbar: "#payer-tool",
                            minWidth: 200
                        },
                    ],
                ],
                done: function (res, curr, count) {
                    // 表格渲染完成后，在表头添加筛选输入框
                    addFilterInputs();
                    // 多次同步列宽，确保完全同步
                    setTimeout(function () {
                        syncColumnWidths();
                        setTimeout(function () {
                            syncColumnWidths();
                        }, 100);
                    }, 200);
                },
                parseData: function (res) {
                    return {
                        code: res.code,
                        msg: res.msg,
                        count: res.count,
                        data: res.data,
                    };
                }
            });

            // 列宽配置 - 可以根据需要修改各列的初始宽度（单位：px）
            var columnWidths = {
                'ID': 60,
                '付款单位名称': 200,
                '类型': 80,
                '开户行名称': 180,
                '银行账号': 180,
                '备注': 150,
                '创建时间': 180
            };

            // 根据表头标题获取列宽配置
            function getColumnWidthByTitle($th) {
                // 从 .layui-table-cell 中获取纯文本，排除筛选输入框
                var $cell = $th.find('.layui-table-cell');
                var title;
                if ($cell.length) {
                    // 克隆元素，移除所有子元素（包括筛选输入框），然后获取文本
                    title = $cell.clone().children().remove().end().text().trim();
                } else {
                    // 如果没有 .layui-table-cell，直接获取文本，但排除筛选输入框
                    title = $th.clone().find('.filter-input-wrapper').remove().end().text().trim();
                }
                return columnWidths[title] || null;
            }

            // 同步表头和表体的列宽 - 根据内容自动调整
            function syncColumnWidths() {
                var $headerTable = $('.layui-table-view .layui-table-header table');
                var $bodyTable = $('.layui-table-view .layui-table-body table');

                if ($headerTable.length && $bodyTable.length) {
                    var $headerThs = $headerTable.find('thead tr th');
                    var $headerCols = $headerTable.find('colgroup col');
                    var $bodyCols = $bodyTable.find('colgroup col');

                    if ($headerCols.length === 0) {
                        var headerColgroup = $('<colgroup></colgroup>');
                        $headerThs.each(function () {
                            headerColgroup.append('<col>');
                        });
                        $headerTable.prepend(headerColgroup);
                        $headerCols = $headerTable.find('colgroup col');
                    }

                    if ($bodyCols.length === 0) {
                        var bodyColgroup = $('<colgroup></colgroup>');
                        $headerThs.each(function () {
                            bodyColgroup.append('<col>');
                        });
                        $bodyTable.prepend(bodyColgroup);
                        $bodyCols = $bodyTable.find('colgroup col');
                    }

                    $headerThs.each(function (index) {
                        var $headerTh = $(this);
                        var configuredWidth = getColumnWidthByTitle($headerTh);
                        var maxWidth;

                        if (configuredWidth) {
                            maxWidth = configuredWidth;
                        } else {
                            maxWidth = $headerTh.outerWidth() || $headerTh.width() || 0;
                            $bodyTable.find('tbody tr').each(function () {
                                var $td = $(this).find('td').eq(index);
                                if ($td.length) {
                                    var originalWidth = $td.css('width');
                                    $td.css('width', 'auto');
                                    var contentWidth = $td.outerWidth() || $td.width() || 0;
                                    $td.css('width', originalWidth);
                                    var padding = parseInt($td.css('padding-left')) + parseInt($td.css('padding-right')) || 30;
                                    var totalWidth = contentWidth + padding;
                                    if (totalWidth > maxWidth) {
                                        maxWidth = totalWidth;
                                    }
                                }
                            });
                        }

                        var titleText = $headerTh.text().trim();
                        if (titleText.indexOf('操作') !== -1) {
                            return;
                        }

                        if ($headerCols.length > index) {
                            $headerCols.eq(index).css('width', maxWidth + 'px').attr('width', maxWidth);
                        }
                        if ($bodyCols.length > index) {
                            $bodyCols.eq(index).css('width', maxWidth + 'px').attr('width', maxWidth);
                        }

                        $headerTh.css('width', maxWidth + 'px');
                        $bodyTable.find('tbody tr td').eq(index).css('width', maxWidth + 'px');
                    });

                    $headerTable.css({
                        'table-layout': 'auto',
                        'width': '100%'
                    });
                    $bodyTable.css({
                        'table-layout': 'auto',
                        'width': '100%'
                    });
                }
            }

            // 统一的表格重新加载函数
            function reloadTable(options) {
                options = options || {};
                var defaultOptions = {
                    where: filterParams,
                    done: function () {
                        addFilterInputs();
                        setTimeout(function () {
                            syncColumnWidths();
                        }, 100);
                    }
                };
                var finalOptions = $.extend({}, defaultOptions, options);
                table.reload('payer-table', finalOptions);
            }

            // 在表头添加筛选输入框
            function addFilterInputs() {
                setTimeout(function () {
                    var filterConfig = {
                        'name': {
                            type: 'text',
                            placeholder: '筛选付款单位名称',
                            source: window.location.origin + "/api/v1/payer/",
                            labelField: 'name',
                            valueField: 'name'
                        },
                        'bank_name': {
                            type: 'text',
                            placeholder: '筛选开户行',
                            source: window.location.origin + "/api/v1/payer/",
                            labelField: 'bank_name',
                            valueField: 'bank_name',
                            unique: true
                        },
                        'account_number': { type: 'text', placeholder: '筛选银行账号' },
                        'remark': { type: 'text', placeholder: '筛选备注' }
                    };

                    Object.keys(filterConfig).forEach(function (field) {
                        var $th = $('th[data-field="' + field + '"]');
                        if ($th.length && !$th.find('.filter-input').length) {
                            var config = filterConfig[field];
                            var $filterDiv = $('<div class="filter-input-wrapper" style="margin-top: 5px;"></div>');
                            var $input;

                            // 检查是否需要 Autocomplete (Source)
                            var listId = config.source ? 'list-' + field : null;
                            var listAttr = listId ? ' list="' + listId + '"' : '';

                            $input = $('<input type="' + config.type + '" class="layui-input filter-input" placeholder="' + config.placeholder + '" data-field="' + field + '"' + listAttr + ' style="height: 28px; font-size: 12px; padding: 0 8px;">');

                            if (filterParams[field]) {
                                $input.val(filterParams[field]);
                            }
                            $filterDiv.append($input);

                            // 如果有 source，添加 datalist 和事件
                            if (config.source) {
                                var $datalist = $('<datalist id="' + listId + '"></datalist>');
                                $filterDiv.append($datalist);

                                // 绑定 focus 事件加载数据
                                $input.on('focus', function () {
                                    var $thisDatalist = $('#' + listId);
                                    if ($thisDatalist.children().length > 0) return;

                                    $.ajax({
                                        url: config.source,
                                        type: 'GET',
                                        data: { limit: 1000 },
                                        headers: {
                                            Authorization: "Bearer " + localStorage.getItem("access_token"),
                                        },
                                        success: function (res) {
                                            if (res.code === 0 && res.data) {
                                                $thisDatalist.empty();
                                                var items = res.data;
                                                var validValues = new Set();

                                                items.forEach(function (item) {
                                                    var val = item[config.valueField];
                                                    if (val) {
                                                        if (config.unique) {
                                                            if (validValues.has(val)) return;
                                                            validValues.add(val);
                                                        }

                                                        var label = item[config.labelField] || val;
                                                        $thisDatalist.append('<option value="' + val + '">' + (label !== val ? label : '') + '</option>');
                                                    }
                                                });
                                            }
                                        }
                                    });
                                });
                            }

                            $th.append($filterDiv);
                        }
                    });
                    setTimeout(function () {
                        syncColumnWidths();
                    }, 50);
                }, 100);
            }

            // 监听表格筛选
            table.on('toolbar(payer-table)', function (obj) {
                if (obj.event === 'payer-toolbar-add') {
                    $("#payer-form")[0].reset();
                    $("#payer-form input[name='id']").val(0);
                    layer.open({
                        type: 1,
                        shade: false,
                        content: $("#payer-form"),
                        area: ["50%", "90%"],
                    });
                    form.render($("#payer-form"));
                }
            });

            // 监听行工具事件
            table.on('tool(payer-table)', function (obj) {
                var data = obj.data;
                if (obj.event === 'payer-tool-edit') {
                    form.val("payer-form", data);
                    layer.open({
                        type: 1,
                        shade: false,
                        content: $("#payer-form"),
                        area: ["50%", "90%"],
                    });
                    form.render($("#payer-form"));
                } else if (obj.event === 'payer-tool-del') {
                    layer.confirm('确定要删除这个付款单位吗？', { icon: 3, title: '提示' }, function (confirmIndex) {
                        $.ajax({
                            url: window.location.origin + `/api/v1/payer/${data.id}`,
                            type: "DELETE",
                            contentType: "application/json",
                            headers: {
                                Authorization: "Bearer " + localStorage.getItem("access_token"),
                            },
                            success: function (res) {
                                if (res.code === 0) {
                                    layer.msg(res.msg, { icon: 1 });
                                    reloadTable();
                                } else {
                                    layer.msg(res.msg || '删除失败', { icon: 2 });
                                }
                                layer.close(confirmIndex);
                            },
                            error: function () {
                                layer.msg('删除失败，请重试', { icon: 2 });
                                layer.close(confirmIndex);
                            }
                        });
                    });
                }
            });

            // 监听单元格编辑
            table.on('edit(payer-table)', function (obj) {
                var value = obj.value;
                var data = obj.data;
                var field = obj.field;

                var updateData = {};
                updateData[field] = value;
                updateData.id = data.id;

                $.ajax({
                    url: window.location.origin + `/api/v1/payer/${data.id}`,
                    type: "PUT",
                    contentType: "application/json",
                    data: JSON.stringify(updateData),
                    headers: {
                        Authorization: "Bearer " + localStorage.getItem("access_token"),
                    },
                    success: function (res) {
                        if (res.code === 0) {
                            layer.msg('更新成功', { icon: 1, time: 1000 });
                        } else {
                            layer.msg(res.msg || '更新失败', { icon: 2 });
                            reloadTable();
                        }
                    },
                    error: function () {
                        layer.msg('更新失败，请重试', { icon: 2 });
                        reloadTable();
                    }
                });
            });

            // 表单提交
            form.on("submit(payer-form-btn)", function (data) {
                var field = data.field;
                let method, url;
                if (field.id == 0) {
                    field.id = null;
                    method = "POST";
                    url = window.location.origin + "/api/v1/payer/";
                } else {
                    method = "PUT";
                    url = window.location.origin + `/api/v1/payer/${field.id}`;
                }

                if (field.account_number) {
                    // 不进行转换，保持字符串
                }

                $.ajax({
                    url: url,
                    type: method,
                    contentType: "application/json",
                    data: JSON.stringify(field),
                    headers: {
                        Authorization: "Bearer " + localStorage.getItem("access_token"),
                    },
                    success: function (res) {
                        if (res.code === 0) {
                            layer.msg(res.msg, { icon: 1 });
                            layer.closeAll();
                            reloadTable();
                        } else {
                            layer.msg(res.msg || '操作失败', { icon: 2 });
                        }
                    },
                    error: function () {
                        layer.msg('操作失败，请重试', { icon: 2 });
                    }
                });
                return false;
            });

            // 监听筛选栏输入，实现模糊搜索
            var filterTimer = null;
            $(document).on('input', '.filter-input', function () {
                var $input = $(this);
                var field = $input.data('field');
                var value = $input.val().trim();

                if (value) {
                    filterParams[field] = value;
                } else {
                    delete filterParams[field];
                }

                clearTimeout(filterTimer);
                filterTimer = setTimeout(function () {
                    reloadTable({
                        page: {
                            curr: 1
                        }
                    });
                }, 1200);
            });
        });
    </script>
</body>

</html>