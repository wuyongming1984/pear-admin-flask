# æœåŠ¡å™¨æ›´æ–°éƒ¨ç½²æŒ‡å—

## ğŸš€ æ–¹æ¡ˆä¸€ï¼šä½¿ç”¨è‡ªåŠ¨æ›´æ–°è„šæœ¬ï¼ˆæ¨èï¼‰

### æ­¥éª¤ 1ï¼šåœ¨æœåŠ¡å™¨ä¸Šåˆ›å»ºæ›´æ–°è„šæœ¬

åœ¨æœåŠ¡å™¨ SSH ç»ˆç«¯æ‰§è¡Œï¼š

```bash
cd /root/pear-admin-flask

# åˆ›å»ºæ›´æ–°è„šæœ¬
cat > server_update.sh << 'SCRIPT_EOF'
#!/bin/bash
# æœåŠ¡å™¨ç«¯æ›´æ–°å’Œé‡æ–°éƒ¨ç½²è„šæœ¬

set -e

echo "=================================================="
echo "Pear Admin Flask æœåŠ¡å™¨æ›´æ–°è„šæœ¬"
echo "=================================================="
echo

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# æ£€æŸ¥æ˜¯å¦åœ¨é¡¹ç›®ç›®å½•
if [ ! -f "docker-compose.yml" ]; then
    echo -e "${RED}é”™è¯¯ï¼šè¯·åœ¨é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œæ­¤è„šæœ¬${NC}"
    exit 1
fi

echo -e "${GREEN}[1/6] åœæ­¢å½“å‰æœåŠ¡...${NC}"
docker-compose down

echo
echo -e "${GREEN}[2/6] æ‹‰å–æœ€æ–°ä»£ç ...${NC}"
git pull origin main || {
    echo -e "${YELLOW}è­¦å‘Šï¼šGit æ‹‰å–å¤±è´¥ï¼Œè·³è¿‡æ­¤æ­¥éª¤${NC}"
}

echo
echo -e "${GREEN}[3/6] æ£€æŸ¥ .env æ–‡ä»¶...${NC}"
if [ -f ".env" ]; then
    echo -e "${GREEN}.env æ–‡ä»¶å·²å­˜åœ¨ï¼Œä¿ç•™ç°æœ‰é…ç½®${NC}"
else
    echo -e "${RED}é”™è¯¯ï¼š.env æ–‡ä»¶ä¸å­˜åœ¨${NC}"
    exit 1
fi

echo
echo -e "${GREEN}[4/6] é‡æ–°æ„å»ºå¹¶å¯åŠ¨æœåŠ¡...${NC}"
docker-compose up -d --build

echo
echo -e "${GREEN}[5/6] ç­‰å¾… MySQL å¯åŠ¨...${NC}"
sleep 30

echo
echo -e "${GREEN}[6/6] åˆå§‹åŒ–æ•°æ®åº“ï¼ˆå¦‚æœéœ€è¦ï¼‰...${NC}"
docker-compose exec -T web flask init || {
    echo -e "${YELLOW}æ•°æ®åº“å¯èƒ½å·²ç»åˆå§‹åŒ–è¿‡äº†${NC}"
}

echo
echo "=================================================="
echo -e "${GREEN}âœ… æœåŠ¡æ›´æ–°å®Œæˆï¼${NC}"
echo "=================================================="
echo
echo "æœåŠ¡çŠ¶æ€ï¼š"
docker-compose ps
echo
SCRIPT_EOF

# ç»™è„šæœ¬æ·»åŠ æ‰§è¡Œæƒé™
chmod +x server_update.sh
```

### æ­¥éª¤ 2ï¼šè¿è¡Œæ›´æ–°è„šæœ¬

```bash
cd /root/pear-admin-flask
./server_update.sh
```

---

## ğŸ“‹ æ–¹æ¡ˆäºŒï¼šæ‰‹åŠ¨æ›´æ–°æ­¥éª¤

### æ­¥éª¤ 1ï¼šæ‹‰å–æœ€æ–°ä»£ç 

```bash
cd /root/pear-admin-flask

# æ‹‰å–æœ€æ–°ä»£ç 
git pull origin main
```

å¦‚æœ git pull å¤±è´¥ï¼Œå¯ä»¥é‡æ–°å…‹éš†ï¼š

```bash
cd /root
rm -rf pear-admin-flask
git clone https://github.com/wuyongming1984/pear-admin-flask.git
cd pear-admin-flask

# æ¢å¤ .env æ–‡ä»¶ï¼ˆå¦‚æœæœ‰å¤‡ä»½ï¼‰
# cp /root/pear-admin-flask-backup/.env .
```

### æ­¥éª¤ 2ï¼šåœæ­¢å¹¶é‡æ–°éƒ¨ç½²

```bash
cd /root/pear-admin-flask

# åœæ­¢æœåŠ¡ï¼ˆä¿ç•™æ•°æ®ï¼‰
docker-compose down

# é‡æ–°æ„å»ºå¹¶å¯åŠ¨
docker-compose up -d --build

# ç­‰å¾…æœåŠ¡å¯åŠ¨
sleep 30

# åˆå§‹åŒ–æ•°æ®åº“ï¼ˆå¦‚æœéœ€è¦ï¼‰
docker-compose exec web flask init
```

### æ­¥éª¤ 3ï¼šå¯¼å…¥æ•°æ®ï¼ˆå¦‚æœæœ‰æ•°æ®æ–‡ä»¶ï¼‰

å¦‚æœæ‚¨æœ‰ `mysql_export.sql` æ–‡ä»¶ï¼š

```bash
cd /root/pear-admin-flask

# å¯¼å…¥æ•°æ®
docker-compose exec -T mysql mysql -u root -p$(grep MYSQL_ROOT_PASSWORD .env | cut -d '=' -f2) pear_admin < mysql_export.sql

# éªŒè¯æ•°æ®
docker-compose exec mysql mysql -u root -p$(grep MYSQL_ROOT_PASSWORD .env | cut -d '=' -f2) pear_admin -e "
SELECT 'ç”¨æˆ·è¡¨' as table_name, COUNT(*) as count FROM ums_user
UNION ALL SELECT 'è®¢å•è¡¨', COUNT(*) FROM ums_order
UNION ALL SELECT 'ä¾›åº”å•†è¡¨', COUNT(*) FROM ums_supplier;
"
```

---

## ğŸ”§ å¸¸ç”¨ç»´æŠ¤å‘½ä»¤

### æŸ¥çœ‹æœåŠ¡çŠ¶æ€

```bash
cd /root/pear-admin-flask
docker-compose ps
```

### æŸ¥çœ‹æ—¥å¿—

```bash
# æŸ¥çœ‹æ‰€æœ‰æ—¥å¿—
docker-compose logs -f

# åªæŸ¥çœ‹ Web åº”ç”¨æ—¥å¿—
docker-compose logs -f web

# åªæŸ¥çœ‹ MySQL æ—¥å¿—
docker-compose logs -f mysql
```

### é‡å¯æœåŠ¡

```bash
# é‡å¯æ‰€æœ‰æœåŠ¡
docker-compose restart

# åªé‡å¯ Web åº”ç”¨
docker-compose restart web

# åªé‡å¯ MySQL
docker-compose restart mysql
```

### åœæ­¢æœåŠ¡

```bash
# åœæ­¢æœåŠ¡ï¼ˆä¿ç•™æ•°æ®ï¼‰
docker-compose down

# åœæ­¢å¹¶åˆ é™¤æ•°æ®å·ï¼ˆå±é™©ï¼ä¼šåˆ é™¤æ•°æ®åº“æ•°æ®ï¼‰
docker-compose down -v
```

### å¤‡ä»½æ•°æ®åº“

```bash
cd /root/pear-admin-flask

# å¤‡ä»½æ•°æ®åº“
docker-compose exec mysql mysqldump -u root -p$(grep MYSQL_ROOT_PASSWORD .env | cut -d '=' -f2) pear_admin > backup_$(date +%Y%m%d_%H%M%S).sql

# æŸ¥çœ‹å¤‡ä»½æ–‡ä»¶
ls -lh backup_*.sql
```

---

## ğŸ†˜ å¸¸è§é—®é¢˜

### 1. æœåŠ¡æ— æ³•å¯åŠ¨

```bash
# æŸ¥çœ‹è¯¦ç»†é”™è¯¯ä¿¡æ¯
docker-compose logs

# é‡æ–°æ„å»º
docker-compose down
docker-compose build --no-cache
docker-compose up -d
```

### 2. æ•°æ®åº“è¿æ¥å¤±è´¥

```bash
# æ£€æŸ¥ MySQL æ˜¯å¦è¿è¡Œ
docker-compose ps

# æŸ¥çœ‹ MySQL æ—¥å¿—
docker-compose logs mysql

# é‡å¯ MySQL
docker-compose restart mysql
sleep 10
docker-compose restart web
```

### 3. ç«¯å£è¢«å ç”¨

```bash
# æŸ¥çœ‹ç«¯å£å ç”¨
netstat -tlnp | grep 5050

# ä¿®æ”¹ç«¯å£ï¼ˆç¼–è¾‘ docker-compose.ymlï¼‰
vi docker-compose.yml
# ä¿®æ”¹ ports: - "5050:5050" ä¸ºå…¶ä»–ç«¯å£

# é‡å¯æœåŠ¡
docker-compose down
docker-compose up -d
```

### 4. ç£ç›˜ç©ºé—´ä¸è¶³

```bash
# æ¸…ç† Docker ç¼“å­˜
docker system prune -a

# æŸ¥çœ‹ç£ç›˜ä½¿ç”¨
df -h

# æ¸…ç†æ—§çš„å¤‡ä»½æ–‡ä»¶
rm -f /root/pear-admin-flask/backup_*.sql
```

---

## ğŸ“Š ç›‘æ§å’Œç»´æŠ¤

### å®šæœŸå¤‡ä»½ï¼ˆæ¨èï¼‰

åˆ›å»ºå®šæ—¶å¤‡ä»½è„šæœ¬ï¼š

```bash
# åˆ›å»ºå¤‡ä»½è„šæœ¬
cat > /root/backup_db.sh << 'EOF'
#!/bin/bash
cd /root/pear-admin-flask
BACKUP_FILE="backup_$(date +%Y%m%d_%H%M%S).sql"
docker-compose exec -T mysql mysqldump -u root -p$(grep MYSQL_ROOT_PASSWORD .env | cut -d '=' -f2) pear_admin > "$BACKUP_FILE"
echo "æ•°æ®åº“å¤‡ä»½å®Œæˆ: $BACKUP_FILE"

# åªä¿ç•™æœ€è¿‘7å¤©çš„å¤‡ä»½
find /root/pear-admin-flask -name "backup_*.sql" -mtime +7 -delete
EOF

chmod +x /root/backup_db.sh

# æ·»åŠ åˆ°å®šæ—¶ä»»åŠ¡ï¼ˆæ¯å¤©å‡Œæ™¨2ç‚¹å¤‡ä»½ï¼‰
(crontab -l 2>/dev/null; echo "0 2 * * * /root/backup_db.sh") | crontab -
```

### æŸ¥çœ‹èµ„æºä½¿ç”¨

```bash
# æŸ¥çœ‹å®¹å™¨èµ„æºä½¿ç”¨
docker stats

# æŸ¥çœ‹ç£ç›˜ä½¿ç”¨
docker system df
```
