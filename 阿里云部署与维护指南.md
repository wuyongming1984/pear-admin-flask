# 阿里云全流程部署与维护指南

本文档整合了**阿里云首次部署**、**日常开发推送**及**服务器更新维护**的所有核心步骤。

---

## 📋 1. 项目信息

- **GitHub 仓库**: `https://github.com/wuyongming1984/pear-admin-flask.git`
- **服务器实例**: `i-uf6grczcwjr1t7f5efkv`
- **默认用户**: `root`
- **应用端口**: `5050`
- **Web URL**: `http://<服务器IP>:5050`

---

## 🚀 2. 首次部署（从零开始）

如果您是第一次在服务器上部署本项目，请执行以下步骤。

### 2.1 连接服务器
```powershell
# 在本地终端执行 (替换为实际IP)
ssh root@8.159.138.234
```

### 2.2 一键部署命令
在服务器终端直接执行以下组合命令，自动完成克隆、环境配置和启动：

```bash
cd /root && \
rm -rf pear-admin-flask && \
git clone https://github.com/wuyongming1984/pear-admin-flask.git && \
cd pear-admin-flask && \
chmod +x deploy.sh && \
./deploy.sh
```

**脚本自动完成：**
- 安装 Docker & Docker Compose
- 配置国内镜像加速（解决拉取慢的问题）
- 生成安全密码
- 构建并启动服务

**验证部署：**
```bash
docker-compose ps
# 应看到 pear_admin_web, pear_admin_mysql, pear_admin_nginx 均为 Up 状态
```

---

## 💻 3. 日常开发与推送（本地操作）

在本地电脑修改代码后的标准流程：

### 3.1 提交代码
```powershell
# 1. 进入项目目录
cd d:\pear_admin\pear-admin-flask

# 2. 添加修改
git add .

# 3. 提交 (请写清楚修改内容)
git commit -m "feat: 增加新功能" 
# 或 git commit -m "fix: 修复某Bug"

# 4. 推送到 GitHub
git push
```

---

## 🔄 4. 服务器更新（远程操作）

代码推送到 GitHub 后，需要在服务器上拉取并生效。根据更新内容的程度，选择以下方案。

### 方案 A：常规更新（最常用）
**适用**：只修改了 Python 代码、HTML 模板或静态文件。

```bash
# 1. 进入目录
cd /root/pear-admin-flask

# 2. 拉取最新代码
git pull

# 3. 重启 Web 容器 (静态文件和模板立即生效，Python代码重启后生效)
docker-compose restart web

# 4. 查看日志确认无误
docker-compose logs --tail=50 -f web
```

### 方案 B：依赖/配置更新（较慢）
**适用**：修改了 `Dockerfile`、`requirements.txt` 或新增了系统依赖。

```bash
cd /root/pear-admin-flask
git pull

# 强制重新构建并启动
docker-compose down
docker-compose build --no-cache web
docker-compose up -d
```

### 方案 C：数据库结构更新（关键）
**适用**：修改了 ORM 模型（如新增表、新增字段）。如果不执行此步，会报 `parsererror` 或 500 错误。

```bash
# 1. 先更新代码
cd /root/pear-admin-flask
git pull

# 2. 如果需要，重建容器（参考方案B）
# docker-compose up -d --build 

# 3. 【执行数据库更新脚本】
# 此脚本会自动检测缺失的表(如 ums_payer)和字段(如 supplier_contact_person)并创建
docker-compose exec web python scripts/update_db_schema.py

# 4. 重启服务以加载新结构
docker-compose restart web
```

---

## ⚙️ 5. 常用运维命令

所有命令需在 `/root/pear-admin-flask` 目录下执行。

| 功能 | 命令 |
| :--- | :--- |
| **查看状态** | `docker-compose ps` |
| **实时日志(Web)** | `docker-compose logs -f web` |
| **实时日志(MySQL)** | `docker-compose logs -f mysql` |
| **重启 Web** | `docker-compose restart web` |
| **重启所有** | `docker-compose restart` |
| **停止服务** | `docker-compose down` |
| **进入 Web 容器** | `docker exec -it pear_admin_web bash` |
| **进入 DB 容器** | `docker exec -it pear_admin_mysql mysql -u root -p pear_admin` |

### 数据库维护

**手动导出备份：**
```bash
docker-compose exec mysql mysqldump -u root -p$(grep MYSQL_ROOT_PASSWORD .env | cut -d '=' -f2) pear_admin > backup_$(date +%Y%m%d).sql
```

**从 Navicat 导入数据：**
1. 确保安全组开放 3306 端口（仅限临时，建议用 SSH 隧道）。
2. 或使用 Navicat 的“数据传输”功能，源选本地 SQLite，目标选服务器 MySQL。

---

## ❓ 6. 常见问题排查

### Q1: 页面提示 "parsererror" 或 500
- **原因**：通常是后端报错。
- **排查**：执行 `docker-compose logs --tail=100 web` 查看最新报错堆栈。
- **解决**：如果是数据库缺失表/字段，请执行 **方案 C** 中的数据库更新脚本。

### Q2: 镜像拉取超时 (dial tcp i/o timeout)
- **解决**：确保使用了国内镜像源。我们的 `deploy.sh` 脚本已自动配置。如果依然慢，尝试重启 Docker：`systemctl restart docker`。

### Q3: Git pull 失败 (Unable to access github.com)
- **解决**：这是网络波动。多试几次 `git pull`，或者临时修改 `/etc/hosts` 指向 GitHub 的可用 IP。

---
**文档版本**: 2026-01-15 (Merged)
