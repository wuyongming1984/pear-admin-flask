# 阿里云服务器部署步骤

## 📋 部署信息

- **GitHub 仓库**: https://github.com/wuyongming1984/pear-admin-flask.git
- **服务器实例**: i-uf6grczcwjr1t7f5efkv
- **用户名**: root
- **部署端口**: 5050

## 🚀 快速部署（5步完成）

### 第一步：获取服务器公网 IP

1. 登录阿里云控制台：https://ecs.console.aliyun.com
2. 找到实例 `i-uf6grczcwjr1t7f5efkv`
3. 记下公网 IP 地址（例如：8.159.138.234）

### 第二步：连接到服务器

在本地 PowerShell 中执行：

```powershell
# 替换为你的服务器公网 IP
ssh root@8.159.138.234

# 输入密码后登录
```Wu19840506

### 第三步：克隆 GitHub 代码

在服务器上执行：

```bash
# 进入 root 目录
cd /root
rm -rf pear-admin-flask
# 克隆 GitHub 仓库
git clone https://github.com/wuyongming1984/pear-admin-flask.git

# 进入项目目录
cd pear-admin-flask

# 查看文件是否都在
ls -la
```

### 第四步：一键部署

```bash
# 赋予执行权限
chmod +x deploy.sh

# 执行一键部署脚本（国内优化版）
./deploy.sh
```

脚本会自动完成以下操作：
- ✅ 安装 Docker 和 Docker Compose
- ✅ **配置 Docker 镜像加速器**（使用国内源，解决拉取镜像慢的问题）
- ✅ 生成随机安全密码
- ✅ 构建应用镜像（使用加速器后速度提升 10 倍）
- ✅ 启动 MySQL 和 Flask 服务

**镜像加速器说明**：
- 使用中科大镜像源
- 使用网易镜像源
- 使用百度镜像源
- 自动配置日志轮转（防止日志占满磁盘）

**重要**：脚本执行完成后会显示数据库密码，请保存这些密码！

**预计时间**：首次部署约 5-10 分钟（之前需要 30 分钟或超时）

### 第五步：配置安全组

1. 返回阿里云控制台
2. 找到实例 `i-uf6grczcwjr1t7f5efkv`
3. 点击"安全组" → "配置规则" → "手动添加"
4. 添加以下规则：

| 协议类型 | 端口范围 | 授权对象 | 说明 |
|---------|---------|---------|------|
| TCP | 5050 | 0.0.0.0/0 | Flask 应用端口 |
| TCP | 22 | 0.0.0.0/0 | SSH 连接 |

5. 点击"保存"

### 第六步：访问应用

在浏览器中打开：

```
http://<你的服务器IP>:5050
```

🎉 部署完成！

## 📝 完整部署命令（复制粘贴版）

### 在本地 PowerShell 执行：

```powershell
# 连接到服务器
ssh root@8.159.138.234
# 输入密码后登录
```

### 在服务器上执行（一键命令）：

```bash
cd /root && git clone https://github.com/wuyongming1984/pear-admin-flask.git && cd pear-admin-flask && chmod +x deploy.sh && ./deploy.sh
```

### 或者分步执行：

```bash
# 1. 进入 root 目录
cd /root

# 2. 克隆代码
git clone https://github.com/wuyongming1984/pear-admin-flask.git

# 3. 进入项目目录
cd pear-admin-flask

# 4. 执行部署脚本
chmod +x deploy.sh
./deploy.sh
```

## 🔍 验证部署状态

```bash
# 查看服务运行状态
docker-compose ps

# 应该看到两个服务都在运行：
# - pear_admin_mysql (Up)
# - pear_admin_web   (Up)

# 查看日志
docker-compose logs -f

# 查看 Web 应用日志
docker-compose logs -f web

# 查看 MySQL 日志
docker-compose logs -f mysql
```

## ⚙️ 常用管理命令

```bash
# 停止服务
docker-compose stop

# 启动服务
docker-compose start

# 重启服务
docker-compose restart

# 查看日志
docker-compose logs -f

# 进入 Web 容器
docker-compose exec web bash

# 进入 MySQL 容器
docker-compose exec mysql bash
```

## 🔄 更新代码（以后修改代码后）

### 方法 1：快速更新（只更新代码，不重新构建镜像）

```bash
cd /root/pear-admin-flask
git pull
docker-compose restart web
```

### 方法 2：完整更新（重新构建镜像）

```bash
# 在服务器上执行
cd /root/pear-admin-flask

# 拉取最新代码
git pull

# 重新构建并启动
docker-compose down
docker-compose build --no-cache web
docker-compose up -d

# 查看日志确认启动成功
docker-compose logs -f web
```

### 方法 3：强制重新部署（推荐，最彻底）

```bash
cd /root
rm -rf pear-admin-flask
git clone https://github.com/wuyongming1984/pear-admin-flask.git
cd pear-admin-flask
chmod +x deploy.sh
./deploy.sh
```

## ❗ 常见问题

### 问题 1：无法连接服务器

**错误信息**：
```
ssh: connect to host port 22: Connection refused
```

**原因**：
1. SSH 命令格式错误（如：`ssh root@ 8.159.138.234` 有空格）
2. 安全组未开放 22 端口

**解决方案**：

**方案 1**：修正 SSH 命令
```bash
# 错误示例
ssh root@ 8.159.138.234  # ❌ @ 和 IP 之间有空格

# 正确示例
ssh root@8.159.138.234   # ✅ 没有空格
```

**方案 2**：配置安全组
1. 登录阿里云控制台
2. 找到实例 → 安全组 → 配置规则
3. 添加入方向规则：端口 22，协议 TCP，授权对象 0.0.0.0/0

**方案 3**：使用阿里云控制台远程连接（推荐）
1. 阿里云控制台 → 实例
2. 点击"远程连接"按钮
3. 选择 Workbench 或 VNC 远程连接

### 问题 2：Docker 镜像拉取超时

**错误信息**：
```
failed to solve: DeadlineExceeded: python:3.10-slim: 
dial tcp 69.171.224.36:443: i/o timeout
```

**原因**：国内访问 Docker Hub 很慢或超时

**解决方案**：

✅ **新版部署脚本已自动解决此问题！**

新的 `deploy.sh` 脚本已自动配置镜像加速器，无需手动操作。

如果仍然遇到问题，手动配置：

```bash
# 配置镜像加速器
sudo mkdir -p /etc/docker
sudo tee /etc/docker/daemon.json <<-'EOF'
{
  "registry-mirrors": [
    "https://docker.mirrors.ustc.edu.cn",
    "https://hub-mirror.c.163.com",
    "https://mirror.baidubce.com"
  ]
}
EOF

# 重启 Docker
sudo systemctl daemon-reload
sudo systemctl restart docker

# 重新部署
cd /root/pear-admin-flask
docker-compose down -v
docker-compose build --no-cache
docker-compose up -d
```

### 问题 3：git clone 失败

**错误信息**：
```
fatal: unable to access 'https://github.com/...': Could not resolve host
```

**解决方案**：
```bash
# 方案 1：检查网络
ping github.com

# 方案 2：多试几次
git clone https://github.com/wuyongming1984/pear-admin-flask.git

# 方案 3：使用 Gitee 镜像
# 先在 Gitee 创建仓库并同步 GitHub 代码
git clone https://gitee.com/你的用户名/pear-admin-flask.git
```

### 问题 4：系统服务重启提示

**现象**：出现 "Daemons using outdated libraries" 对话框

**解决**：
- 按 Tab 键切换到 `<Ok>`
- 按 Enter 确认
- 这是正常的系统更新提示，不影响部署

### 问题 5：无法访问 http://IP:5050

**检查清单**：
1. ✅ 安全组是否开放 5050 端口
2. ✅ 服务是否正常运行：`docker-compose ps`
3. ✅ 查看日志：`docker-compose logs web`
4. ✅ 检查防火墙：`sudo ufw status`

### 问题 6：MySQL 连接失败

**解决**：
```bash
# 查看 MySQL 容器状态
docker-compose ps mysql

# 查看 MySQL 日志
docker-compose logs mysql

# 重启 MySQL
docker-compose restart mysql

# 等待 30 秒后重启 Web
docker-compose restart web
```

## 🔒 安全建议

### 1. 修改 SSH 密码

```bash
passwd
# 输入新密码
```

### 2. 修改 .env 中的密码

```bash
cd /root/pear-admin-flask
nano .env
# 修改所有密码为强密码
```

### 3. 限制 SSH 访问 IP

在阿里云安全组中：
- 将 22 端口的授权对象从 `0.0.0.0/0` 改为你的固定 IP

### 4. 配置防火墙

```bash
# 启用防火墙（可选）
sudo ufw enable
sudo ufw allow 22
sudo ufw allow 5050
```

## 📊 性能监控

### 查看系统资源

```bash
# 查看 CPU 和内存
htop
# 或
top

# 查看磁盘使用
df -h

# 查看 Docker 容器资源
docker stats

# 查看端口占用
netstat -tlnp
```

### 设置日志轮转

```bash
# 限制 Docker 日志大小
sudo nano /etc/docker/daemon.json
```

添加：
```json
{
  "log-driver": "json-file",
  "log-opts": {
    "max-size": "10m",
    "max-file": "3"
  }
}
```

重启 Docker：
```bash
sudo systemctl restart docker
```

## 🎯 优化建议

### 1. 配置 Nginx 反向代理

可以通过 80 端口访问，无需加端口号：

```bash
# 安装 Nginx
sudo apt-get install -y nginx

# 创建配置文件
sudo nano /etc/nginx/sites-available/pear-admin

# 添加配置（参考 DEPLOY.md）

# 启用配置
sudo ln -s /etc/nginx/sites-available/pear-admin /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl restart nginx
```

### 2. 配置 HTTPS

使用 Let's Encrypt 免费证书：

```bash
sudo apt-get install -y certbot python3-certbot-nginx
sudo certbot --nginx -d yourdomain.com
```

### 3. 配置自动备份

```bash
# 创建备份脚本
nano /root/backup.sh
```

添加：
```bash
#!/bin/bash
cd /root/pear-admin-flask
docker-compose exec mysql mysqldump -u root -p密码 pear_admin > /root/backups/backup_$(date +%Y%m%d).sql
```

设置定时任务：
```bash
crontab -e
# 添加：每天凌晨 2 点备份
0 2 * * * /root/backup.sh
```

## 📚 相关文档

- 详细部署文档：[DEPLOY.md](./DEPLOY.md)
- Git 操作指南：[GIT_GUIDE.md](./GIT_GUIDE.md)
- 日常更新指南：[更新推送指南.md](./更新推送指南.md)
- 项目说明：[README.md](./README.md)

## 🆘 需要帮助？

如果遇到问题：
1. 查看日志：`docker-compose logs -f`
2. 检查服务状态：`docker-compose ps`
3. 参考 DEPLOY.md 故障排查章节

---

**祝您部署顺利！** 🎉
